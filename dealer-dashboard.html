<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dealer Daily Activity Dashboard ‚Äî ‡∏ô‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÉ‡∏à</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ‚îÄ ROOT VARIABLES (CPACTheme inspired) ‚îÄ‚îÄ‚îÄ */
:root {
  --primary: #0057B8;
  --primary-dark: #003d82;
  --primary-light: #3a7fd4;
  --accent: #00AEEF;
  --accent2: #E8F4FD;
  --success: #00875A;
  --success-bg: #E3FCEF;
  --warn: #FF8B00;
  --warn-bg: #FFF4E5;
  --alert: #DE350B;
  --alert-bg: #FFEBE6;
  --info: #0057B8;
  --info-bg: #E8F4FD;
  --surface: #FFFFFF;
  --surface2: #F4F7FA;
  --surface3: #EBF1F8;
  --border: #D0DCE8;
  --border-light: #E8EFF6;
  --text: #1A2B3C;
  --text-muted: #6B7E8F;
  --text-light: #9AAAB8;
  --shadow: 0 2px 8px rgba(0,87,184,0.10);
  --shadow-md: 0 4px 20px rgba(0,87,184,0.14);
  --shadow-lg: 0 8px 40px rgba(0,87,184,0.18);
  --radius: 8px;
  --radius-sm: 5px;
  --radius-lg: 14px;
  --font: 'IBM Plex Sans Thai', sans-serif;
  --mono: 'IBM Plex Mono', monospace;
  --header-h: 64px;
  --filter-h: 56px;
  --kpi-h: 100px;
  --drawer-w: 480px;
}

/* ‚îÄ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; }
body {
  font-family: var(--font);
  background: var(--surface2);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}
button { font-family: var(--font); cursor: pointer; border: none; background: none; }
input, select { font-family: var(--font); }
a { color: inherit; text-decoration: none; }

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--surface2); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.app-header {
  position: sticky; top: 0; z-index: 100;
  height: var(--header-h);
  background: var(--primary);
  display: flex; align-items: center;
  padding: 0 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  gap: 16px;
}
.header-logo {
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
}
.header-logo-mark {
  width: 36px; height: 36px;
  background: white;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 14px;
  color: var(--primary);
  letter-spacing: -0.5px;
}
.header-title {
  color: white;
  font-size: 15px; font-weight: 700;
  line-height: 1.2;
}
.header-subtitle {
  color: rgba(255,255,255,0.65);
  font-size: 11px; font-weight: 400;
}
.header-spacer { flex: 1; }
.header-time {
  color: rgba(255,255,255,0.75);
  font-size: 11px;
  font-family: var(--mono);
  text-align: right;
  line-height: 1.5;
}
.header-time strong { color: white; font-size: 13px; }
.header-controls {
  display: flex; align-items: center; gap: 8px;
  flex-shrink: 0;
}
.header-controls select {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.25);
  color: white; border-radius: var(--radius-sm);
  padding: 6px 10px; font-size: 12px;
  outline: none; cursor: pointer;
}
.header-controls select option { background: var(--primary-dark); color: white; }
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px; border-radius: var(--radius-sm);
  font-size: 12px; font-weight: 600;
  transition: all 0.15s; cursor: pointer; border: none;
}
.btn-primary { background: white; color: var(--primary); }
.btn-primary:hover { background: var(--accent2); }
.btn-ghost {
  background: rgba(255,255,255,0.12);
  color: white;
  border: 1px solid rgba(255,255,255,0.25);
}
.btn-ghost:hover { background: rgba(255,255,255,0.22); }
.btn-ghost.active { background: rgba(255,255,255,0.28); }

/* ‚îÄ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ‚îÄ */
.filter-bar {
  position: sticky; top: var(--header-h); z-index: 90;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 8px 20px;
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.filter-group {
  display: flex; align-items: center; gap: 4px;
}
.filter-label {
  font-size: 11px; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  white-space: nowrap;
}
.filter-select, .filter-input {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 5px 10px; font-size: 12px; color: var(--text);
  outline: none; height: 30px;
  transition: border-color 0.15s;
}
.filter-select:focus, .filter-input:focus { border-color: var(--primary); }
.filter-input { width: 180px; }
.filter-divider {
  width: 1px; height: 24px; background: var(--border);
  margin: 0 4px; flex-shrink: 0;
}
.filter-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 10px;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  font-size: 11px; font-weight: 600;
  background: var(--surface); color: var(--text-muted);
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.filter-chip:hover { border-color: var(--primary-light); color: var(--primary); }
.filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }

/* ‚îÄ‚îÄ‚îÄ KPI STRIP ‚îÄ‚îÄ‚îÄ */
.kpi-strip {
  padding: 12px 20px;
  display: flex; gap: 10px; overflow-x: auto;
  background: var(--surface);
  border-bottom: 1px solid var(--border-light);
}
.kpi-card {
  flex: 0 0 auto;
  min-width: 120px;
  background: var(--surface2);
  border: 1.5px solid var(--border-light);
  border-radius: var(--radius);
  padding: 10px 14px;
  cursor: pointer; transition: all 0.15s;
  position: relative; overflow: hidden;
}
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 3px; background: var(--primary);
}
.kpi-card.warn::before { background: var(--warn); }
.kpi-card.alert::before { background: var(--alert); }
.kpi-card.success::before { background: var(--success); }
.kpi-card:hover { border-color: var(--primary-light); box-shadow: var(--shadow); transform: translateY(-1px); }
.kpi-card.selected { border-color: var(--primary); background: var(--info-bg); }
.kpi-value {
  font-size: 22px; font-weight: 700; color: var(--primary);
  font-family: var(--mono); line-height: 1;
}
.kpi-card.warn .kpi-value { color: var(--warn); }
.kpi-card.alert .kpi-value { color: var(--alert); }
.kpi-card.success .kpi-value { color: var(--success); }
.kpi-label {
  font-size: 10px; font-weight: 600; color: var(--text-muted);
  margin-top: 4px; line-height: 1.3; text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.main-content {
  padding: 12px 20px;
  transition: margin-right 0.3s;
}
.main-content.drawer-open { margin-right: var(--drawer-w); }

/* ‚îÄ‚îÄ‚îÄ ACTIVITY TABLE ‚îÄ‚îÄ‚îÄ */
.table-wrap {
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow);
}
.table-header-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-light);
  background: var(--surface);
}
.table-title { font-size: 13px; font-weight: 700; color: var(--text); }
.table-count {
  font-size: 11px; color: var(--text-muted);
  background: var(--surface2); border-radius: 20px;
  padding: 2px 8px; font-family: var(--mono);
}
.table-spacer { flex: 1; }
.new-badge-indicator {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 11px; font-weight: 600; color: var(--success);
  background: var(--success-bg); border-radius: 20px;
  padding: 3px 10px;
}
.new-badge-indicator::before {
  content: ''; width: 6px; height: 6px;
  background: var(--success); border-radius: 50%;
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.85); }
}

table {
  width: 100%; border-collapse: collapse;
  table-layout: fixed;
}
thead { position: sticky; top: calc(var(--header-h) + var(--filter-h) + var(--kpi-h)); z-index: 50; }
thead tr { background: var(--surface3); }
th {
  padding: 8px 12px;
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.6px;
  color: var(--text-muted); text-align: left;
  border-bottom: 2px solid var(--border);
  white-space: nowrap; overflow: hidden;
}
th:nth-child(1) { width: 56px; }
th:nth-child(2) { width: 70px; }
th:nth-child(3) { width: 140px; }
th:nth-child(4) { width: 150px; }
th:nth-child(5) { width: 170px; }
th:nth-child(6) { width: auto; }
th:nth-child(7) { width: 120px; }
th:nth-child(8) { width: 160px; }

tbody tr {
  border-bottom: 1px solid var(--border-light);
  transition: background 0.15s;
  cursor: pointer;
}
tbody tr:hover { background: var(--surface2); }
tbody tr.is-new {
  background: linear-gradient(90deg, rgba(0,135,90,0.06) 0%, transparent 60%);
  animation: fadeNew 3s ease forwards;
}
@keyframes fadeNew {
  0% { background: rgba(0,135,90,0.12); }
  100% { background: transparent; }
}
tbody tr.is-new td:first-child::before {
  content: ''; display: block;
  width: 3px; height: 100%;
  background: var(--success);
  position: absolute; left: 0; top: 0;
}
tbody tr td:first-child { position: relative; }
tbody tr.selected-row { background: var(--info-bg) !important; }
td {
  padding: 8px 12px;
  font-size: 12px; color: var(--text);
  vertical-align: middle;
  overflow: hidden;
}
.time-cell {
  font-family: var(--mono);
  font-size: 12px; font-weight: 600;
  color: var(--text-muted);
  white-space: nowrap;
}
.time-cell .new-badge {
  display: block;
  font-size: 9px; font-weight: 700;
  color: var(--success); letter-spacing: 0.5px;
  margin-top: 1px;
}

/* SEVERITY CHIP */
.sev-chip {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 3px 8px; border-radius: 20px;
  font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
  white-space: nowrap;
}
.sev-alert { background: var(--alert-bg); color: var(--alert); }
.sev-warn { background: var(--warn-bg); color: var(--warn); }
.sev-info { background: var(--info-bg); color: var(--info); }

/* EVENT TYPE */
.event-type-cell { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.3; }
.event-type-cell span { display: block; font-size: 10px; font-weight: 400; color: var(--text-muted); margin-top: 1px; }

/* CUSTOMER */
.customer-cell { line-height: 1.4; }
.customer-name { font-weight: 600; font-size: 12px; }
.customer-phone { font-size: 11px; color: var(--text-muted); font-family: var(--mono); }
.copy-btn {
  display: inline-flex; align-items: center;
  padding: 2px 6px; margin-left: 4px;
  border-radius: 4px; font-size: 9px; font-weight: 600;
  background: var(--surface2); color: var(--text-muted);
  border: 1px solid var(--border); cursor: pointer;
  transition: all 0.15s; white-space: nowrap;
}
.copy-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

/* SITE */
.site-cell { line-height: 1.4; }
.site-code { font-family: var(--mono); font-weight: 700; font-size: 12px; color: var(--primary); }
.site-name { font-size: 11px; color: var(--text); }
.site-prov { font-size: 10px; color: var(--text-muted); }
.map-btn {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 6px; margin-top: 2px;
  border-radius: 4px; font-size: 9px; font-weight: 600;
  background: var(--accent2); color: var(--primary);
  border: 1px solid #b3d7f0; cursor: pointer;
  transition: all 0.15s;
}
.map-btn:hover { background: var(--primary); color: white; }

/* KEY DETAIL */
.key-detail {
  font-size: 12px; color: var(--text);
  line-height: 1.4; max-height: 2.8em; overflow: hidden;
}
.key-detail strong { color: var(--primary); }

/* STATE CHIP */
.state-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 10px; border-radius: 20px;
  font-size: 10px; font-weight: 700; white-space: nowrap;
}
.state-pending { background: var(--warn-bg); color: var(--warn); }
.state-approved { background: var(--success-bg); color: var(--success); }
.state-confirmed { background: var(--success-bg); color: var(--success); }
.state-new { background: var(--info-bg); color: var(--primary); }
.state-processing { background: #EDE7F6; color: #512DA8; }
.state-invoiced { background: #E8EAF6; color: #3949AB; }
.state-paid { background: var(--success-bg); color: var(--success); }
.state-rejected { background: var(--alert-bg); color: var(--alert); }
.state-dispatched { background: #E0F7FA; color: #00838F; }
.state-done { background: var(--surface3); color: var(--text-muted); }

/* ACTIONS */
.action-btns {
  display: flex; gap: 4px; flex-wrap: nowrap; align-items: center;
}
.act-btn {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; border-radius: 6px;
  font-size: 13px; transition: all 0.15s; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface);
  position: relative;
}
.act-btn:hover { transform: scale(1.15); box-shadow: var(--shadow); z-index: 1; }
.act-btn.view:hover { background: var(--primary); border-color: var(--primary); }
.act-btn.call:hover { background: var(--success); border-color: var(--success); }
.act-btn.line:hover { background: #06C755; border-color: #06C755; }
.act-btn.approve:hover { background: var(--success); border-color: var(--success); }
.act-btn.reject:hover { background: var(--alert); border-color: var(--alert); }
.act-btn.done:hover { background: var(--text-muted); border-color: var(--text-muted); }
.act-btn:hover { color: white; }
.act-btn[title]:hover::after {
  content: attr(title);
  position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8); color: white;
  padding: 3px 8px; border-radius: 4px; font-size: 10px;
  white-space: nowrap; pointer-events: none; z-index: 999;
  font-family: var(--font);
}

/* ‚îÄ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ‚îÄ */
.pagination {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px; border-top: 1px solid var(--border-light);
  background: var(--surface);
}
.page-btn {
  padding: 5px 12px; border-radius: var(--radius-sm);
  font-size: 12px; font-weight: 600;
  border: 1px solid var(--border); background: var(--surface);
  color: var(--text); cursor: pointer; transition: all 0.15s;
}
.page-btn:hover, .page-btn.active {
  background: var(--primary); color: white; border-color: var(--primary);
}
.page-info { font-size: 11px; color: var(--text-muted); font-family: var(--mono); }

/* ‚îÄ‚îÄ‚îÄ RIGHT DRAWER ‚îÄ‚îÄ‚îÄ */
.drawer-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.25);
  opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.drawer-overlay.open { opacity: 1; pointer-events: auto; }
.right-drawer {
  position: fixed; top: 0; right: 0; bottom: 0;
  width: var(--drawer-w); z-index: 201;
  background: var(--surface);
  box-shadow: -4px 0 40px rgba(0,0,0,0.18);
  transform: translateX(100%); transition: transform 0.3s cubic-bezier(.4,0,.2,1);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.right-drawer.open { transform: translateX(0); }

.drawer-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border-light);
  display: flex; align-items: flex-start; gap: 12px;
  background: var(--surface);
  flex-shrink: 0;
}
.drawer-header-info { flex: 1; }
.drawer-title { font-size: 15px; font-weight: 700; color: var(--text); }
.drawer-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.drawer-close {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  background: var(--surface2); border: 1px solid var(--border);
  font-size: 18px; cursor: pointer; color: var(--text-muted);
  transition: all 0.15s; flex-shrink: 0;
}
.drawer-close:hover { background: var(--alert-bg); color: var(--alert); }

.drawer-body { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 16px; }

.drawer-section-title {
  font-size: 10px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.8px;
  margin-bottom: 8px; padding-bottom: 6px;
  border-bottom: 1px solid var(--border-light);
}

.info-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.info-item { }
.info-key { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; }
.info-val { font-size: 13px; color: var(--text); margin-top: 2px; font-weight: 500; }
.info-val.mono { font-family: var(--mono); }
.info-val.price { color: var(--primary); font-weight: 700; font-family: var(--mono); }
.info-val.margin { color: var(--success); font-weight: 700; font-family: var(--mono); }

/* TIMELINE */
.timeline { display: flex; flex-direction: column; gap: 0; }
.timeline-step {
  display: flex; gap: 12px; align-items: flex-start;
  padding-bottom: 14px; position: relative;
}
.timeline-step:not(:last-child)::before {
  content: ''; position: absolute;
  left: 13px; top: 28px; bottom: 0;
  width: 2px; background: var(--border);
}
.step-dot {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 12px;
  border: 2px solid var(--border); background: var(--surface);
  z-index: 1;
}
.step-dot.active { border-color: var(--primary); background: var(--primary); color: white; }
.step-dot.done { border-color: var(--success); background: var(--success); color: white; }
.step-dot.pending { border-color: var(--warn); background: var(--warn-bg); color: var(--warn); }
.step-content { flex: 1; padding-top: 4px; }
.step-title { font-size: 12px; font-weight: 600; color: var(--text); }
.step-time { font-size: 10px; color: var(--text-muted); font-family: var(--mono); margin-top: 2px; }
.step-note { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

/* HISTORY TABLE */
.history-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.history-table th {
  padding: 5px 8px; font-size: 9px; background: var(--surface2);
  text-align: left; color: var(--text-muted); font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.4px;
}
.history-table td { padding: 6px 8px; border-bottom: 1px solid var(--border-light); color: var(--text); }
.history-table tr:hover td { background: var(--surface2); }

/* QUICK ACTIONS */
.quick-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.qa-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 14px; border-radius: var(--radius);
  font-size: 12px; font-weight: 600; cursor: pointer;
  border: 1.5px solid; transition: all 0.15s;
}
.qa-approve { border-color: var(--success); color: var(--success); background: var(--success-bg); }
.qa-approve:hover { background: var(--success); color: white; }
.qa-reject { border-color: var(--alert); color: var(--alert); background: var(--alert-bg); }
.qa-reject:hover { background: var(--alert); color: white; }
.qa-invoice { border-color: var(--primary); color: var(--primary); background: var(--info-bg); }
.qa-invoice:hover { background: var(--primary); color: white; }
.qa-slots { border-color: var(--warn); color: var(--warn); background: var(--warn-bg); }
.qa-slots:hover { background: var(--warn); color: white; }
.qa-done { border-color: var(--text-muted); color: var(--text-muted); background: var(--surface2); }
.qa-done:hover { background: var(--text-muted); color: white; }

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  padding: 12px 16px; border-radius: var(--radius);
  background: var(--text); color: white;
  font-size: 12px; font-weight: 500;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease;
  max-width: 280px; line-height: 1.4;
}
.toast.success { background: var(--success); }
.toast.warn { background: var(--warn); }
.toast.error { background: var(--alert); }
@keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }
.toast.out { animation: toastOut 0.3s ease forwards; }

/* ‚îÄ‚îÄ‚îÄ AUDIT LOG MODAL ‚îÄ‚îÄ‚îÄ */
.audit-modal {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.4);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.audit-modal.open { opacity: 1; pointer-events: auto; }
.audit-box {
  background: white; border-radius: var(--radius-lg);
  width: 540px; max-width: 95vw; max-height: 80vh;
  display: flex; flex-direction: column;
  box-shadow: var(--shadow-lg);
}
.audit-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border-light);
  display: flex; align-items: center; gap: 10px;
}
.audit-header h3 { font-size: 15px; font-weight: 700; flex: 1; }
.audit-close {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  background: var(--surface2); cursor: pointer; font-size: 18px;
  color: var(--text-muted); border: 1px solid var(--border);
}
.audit-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
.audit-entry {
  padding: 10px 0; border-bottom: 1px solid var(--border-light);
  font-size: 12px;
}
.audit-action { font-weight: 700; color: var(--primary); }
.audit-meta { color: var(--text-muted); font-family: var(--mono); font-size: 11px; margin-top: 2px; }

/* ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ */
.login-screen {
  position: fixed; inset: 0; z-index: 500;
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--accent) 100%);
  display: flex; align-items: center; justify-content: center;
}
.login-card {
  background: white; border-radius: var(--radius-lg);
  padding: 40px 36px; width: 360px; max-width: 95vw;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.login-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 28px; }
.login-logo-mark {
  width: 48px; height: 48px; border-radius: 12px;
  background: var(--primary); color: white;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 18px;
}
.login-logo-text h2 { font-size: 18px; font-weight: 700; color: var(--text); }
.login-logo-text p { font-size: 11px; color: var(--text-muted); }
.login-field { margin-bottom: 16px; }
.login-field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
.login-field input {
  width: 100%; padding: 10px 14px; border: 1.5px solid var(--border);
  border-radius: var(--radius); font-size: 14px; color: var(--text);
  outline: none; transition: border-color 0.15s;
}
.login-field input:focus { border-color: var(--primary); }
.login-btn {
  width: 100%; padding: 12px; border-radius: var(--radius);
  background: var(--primary); color: white; font-size: 15px; font-weight: 700;
  border: none; cursor: pointer; margin-top: 8px; transition: background 0.15s;
}
.login-btn:hover { background: var(--primary-dark); }
.login-hint { font-size: 11px; color: var(--text-muted); margin-top: 12px; text-align: center; }
.login-error { color: var(--alert); font-size: 12px; margin-top: 8px; text-align: center; }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state {
  text-align: center; padding: 60px 20px;
  color: var(--text-muted);
}
.empty-state .emoji { font-size: 48px; margin-bottom: 12px; }
.empty-state h3 { font-size: 16px; font-weight: 700; margin-bottom: 6px; color: var(--text); }
.empty-state p { font-size: 13px; }

/* ‚îÄ‚îÄ‚îÄ LOADING SKELETON ‚îÄ‚îÄ‚îÄ */
.skeleton {
  background: linear-gradient(90deg, var(--surface2) 25%, var(--border-light) 50%, var(--surface2) 75%);
  background-size: 200% 100%; animation: shimmer 1.5s infinite;
  border-radius: 4px;
}
@keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media (max-width: 900px) {
  th:nth-child(4), td:nth-child(4) { display: none; }
  th:nth-child(5), td:nth-child(5) { display: none; }
  :root { --drawer-w: 100vw; }
}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-mark">CP</div>
      <div class="login-logo-text">
        <h2>Dealer Portal</h2>
        <p>‡∏ô‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÉ‡∏à ‚Äî Activity Dashboard</p>
      </div>
    </div>
    <div class="login-field">
      <label>Dealer Token / Username</label>
      <input type="text" id="loginUser" value="dealer01" placeholder="dealer01">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPass" value="1234" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="login-btn" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <p class="login-hint">Demo: dealer01 / 1234</p>
    <p class="login-error" id="loginError"></p>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ -->
<div id="app" style="display:none;">

<!-- HEADER -->
<header class="app-header">
  <div class="header-logo">
    <div class="header-logo-mark">CP</div>
    <div>
      <div class="header-title">Dealer Daily Activity Dashboard</div>
      <div class="header-subtitle" id="headerDate">‚Äî</div>
    </div>
  </div>
  <div class="header-spacer"></div>
  <div class="header-time">
    <div>Last updated</div>
    <strong id="lastUpdated">‚Äî</strong>
  </div>
  <div class="header-controls">
    <select id="intervalSelect" onchange="setInterval_()">
      <option value="0">Auto: Off</option>
      <option value="15">15 ‡∏ß‡∏¥</option>
      <option value="30" selected>30 ‡∏ß‡∏¥</option>
      <option value="60">1 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
      <option value="300">5 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
    </select>
    <button class="btn btn-ghost" id="changedToggle" onclick="toggleChanged()">üîÑ Changed Only</button>
    <button class="btn btn-primary" onclick="doRefresh()">‚ü≥ Refresh Now</button>
    <button class="btn btn-ghost" onclick="openAuditLog()" title="Audit Log">üìã</button>
    <button class="btn btn-ghost" onclick="doLogout()" title="Logout">‚èª</button>
  </div>
</header>

<!-- FILTER BAR -->
<div class="filter-bar">
  <div class="filter-group">
    <span class="filter-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
    <select class="filter-select" id="fDate" onchange="applyFilters()">
      <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
      <option value="yesterday">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</option>
      <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
    </select>
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
    <select class="filter-select" id="fTime" onchange="applyFilters()">
      <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</option>
      <option value="15">15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
      <option value="60">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="240">4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
    </select>
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span>
    <input class="filter-input" id="fProv" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..." style="width:130px" oninput="applyFilters()">
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">Severity</span>
    <span class="filter-chip sev-alert active" data-sev="ALERT" onclick="toggleChip(this,'sev')">üî¥ ALERT</span>
    <span class="filter-chip sev-warn active" data-sev="WARN" onclick="toggleChip(this,'sev')">üü° WARN</span>
    <span class="filter-chip sev-info active" data-sev="INFO" onclick="toggleChip(this,'sev')">üîµ INFO</span>
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>
    <select class="filter-select" id="fType" onchange="applyFilters()">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="SITE_PENDING">‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡∏ï‡πå</option>
      <option value="QUOTE_SENT">‡∏™‡πà‡∏á Quotation</option>
      <option value="ADD_PRODUCT">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
      <option value="BOOKING_REQUEST">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</option>
      <option value="BOOKING_CONFIRMED">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó</option>
      <option value="INVOICE_CREATED">‡∏≠‡∏≠‡∏Å Invoice</option>
      <option value="PAYMENT_PENDING">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</option>
      <option value="PAYMENT_CONFIRMED">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
      <option value="DISPATCH_LIVE">Dispatch Live</option>
      <option value="CUSTOMER_ACTION">Action ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
      <option value="POUR_REMINDER">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó</option>
    </select>
  </div>
  <div class="filter-divider"></div>
  <input class="filter-input" id="fSearch" placeholder="üîç Site / Quote / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå..." oninput="applyFilters()">
</div>

<!-- KPI STRIP -->
<div class="kpi-strip" id="kpiStrip"></div>

<!-- MAIN -->
<div class="main-content" id="mainContent">
  <div class="table-wrap">
    <div class="table-header-bar">
      <span class="table-title">Activity Tape</span>
      <span class="table-count" id="tableCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      <div class="table-spacer"></div>
      <span class="new-badge-indicator" id="newBadge" style="display:none">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
    </div>
    <div style="overflow-x:auto;">
      <table id="actTable">
        <thead>
          <tr>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
            <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th>‡πÑ‡∏ã‡∏ï‡πå/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="actBody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

</div><!-- #app -->

<!-- ‚îÄ‚îÄ‚îÄ RIGHT DRAWER ‚îÄ‚îÄ‚îÄ -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="right-drawer" id="rightDrawer">
  <div class="drawer-header">
    <div class="drawer-header-info">
      <div class="drawer-title" id="drawerTitle">‚Äî</div>
      <div class="drawer-subtitle" id="drawerSubtitle">‚Äî</div>
    </div>
    <div class="drawer-close" onclick="closeDrawer()">‚úï</div>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ AUDIT LOG MODAL ‚îÄ‚îÄ‚îÄ -->
<div class="audit-modal" id="auditModal">
  <div class="audit-box">
    <div class="audit-header">
      <h3>üìã Audit Log</h3>
      <div class="audit-close" onclick="closeAuditLog()">‚úï</div>
    </div>
    <div class="audit-body" id="auditBody"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOCK DATA & STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentUser = null;
let autoRefreshTimer = null;
let showChangedOnly = false;
let selectedKpi = null;
let currentPage = 1;
const PAGE_SIZE = 25;
let allEvents = [];
let filteredEvents = [];
let newEventIds = new Set();
let auditLog = [];
let selectedEventId = null;

const EVENT_TYPES = {
  SITE_PENDING:       { label: '‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡∏ï‡πå', icon: 'üèóÔ∏è' },
  QUOTE_SENT:         { label: '‡∏™‡πà‡∏á Quotation', icon: 'üìÑ' },
  ADD_PRODUCT:        { label: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', icon: '‚ûï' },
  BOOKING_REQUEST:    { label: '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß', icon: 'üìÖ' },
  BOOKING_CONFIRMED:  { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó', icon: '‚úÖ' },
  INVOICE_CREATED:    { label: '‡∏≠‡∏≠‡∏Å Invoice', icon: 'üßæ' },
  PAYMENT_PENDING:    { label: '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞', icon: 'üí≥' },
  PAYMENT_CONFIRMED:  { label: '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', icon: '‚úîÔ∏è' },
  DISPATCH_LIVE:      { label: 'Dispatch Live', icon: 'üöõ' },
  CUSTOMER_ACTION:    { label: 'Action ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', icon: 'üì±' },
  POUR_REMINDER:      { label: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó', icon: '‚è∞' },
};

const STATES = {
  PENDING_APPROVAL: { label: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', cls: 'state-pending' },
  APPROVED:         { label: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', cls: 'state-approved' },
  REJECTED:         { label: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', cls: 'state-rejected' },
  NEW:              { label: '‡πÉ‡∏´‡∏°‡πà', cls: 'state-new' },
  PROCESSING:       { label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô', cls: 'state-processing' },
  CONFIRMED:        { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', cls: 'state-confirmed' },
  INVOICED:         { label: '‡∏≠‡∏≠‡∏Å Invoice', cls: 'state-invoiced' },
  PAID:             { label: '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', cls: 'state-paid' },
  DISPATCHED:       { label: 'Dispatch', cls: 'state-dispatched' },
  DONE:             { label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', cls: 'state-done' },
};

const PROVINCES = ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û','‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ','‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ','‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£','‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ','‡∏£‡∏∞‡∏¢‡∏≠‡∏á','‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤','‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô','‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ','‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà','‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï','‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ','‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤','‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ','‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ','‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°','‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ','‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'];
const CUSTOMER_NAMES = ['‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡πÑ‡∏• ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏µ ‡∏à‡∏≥‡∏Å‡∏±‡∏î','‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏µ‡∏ä‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏°‡∏≤','‡∏´‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô ‡∏ä‡∏ß‡∏ô‡∏ä‡∏±‡∏¢','‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ô‡∏∞ ‡∏≠‡∏î‡∏ó‡∏ô','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡∏à‡∏≥‡∏Å‡∏±‡∏î','‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∏‡∏î‡∏≤ ‡∏î‡∏ß‡∏á‡∏î‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ‡∏à‡∏≥‡∏Å‡∏±‡∏î','‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏£‡∏ó‡∏±‡∏¢ ‡∏á‡∏≤‡∏°‡∏î‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏ô‡∏Å‡∏£ ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢','‡∏´‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô ‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏°‡∏• ‡∏™‡∏∏‡∏Ç‡∏™‡∏°','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î'];
const PRODUCTS = ['‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 240 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 280 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 300 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 320 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 350 ksc'];
const PLANTS = ['‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏ô‡∏≤','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 2','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ'];

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function randFrom(arr) { return arr[randInt(0, arr.length - 1)]; }
function randPhone() { return `08${randInt(1,9)}${randInt(1000000,9999999)}`; }
function fmtTime(date) { return date.toTimeString().slice(0,5); }
function fmtDateTime(date) { return date.toLocaleString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function formatMoney(n) { return n.toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó'; }

let idCounter = 1;
function genEvent(hoursAgo = 0, isNew = false) {
  const now = new Date();
  const ts = new Date(now - hoursAgo * 3600000 - randInt(0, 3600000));
  const types = Object.keys(EVENT_TYPES);
  const type = randFrom(types);
  const prov = randFrom(PROVINCES);
  const siteNum = randInt(1000, 9999);
  const siteCode = `SC-${prov.slice(0,2)}-${siteNum}`;
  const custName = randFrom(CUSTOMER_NAMES);
  const custPhone = randPhone();
  const qtyM3 = randInt(2, 30);
  const product = randFrom(PRODUCTS);
  const plant = randFrom(PLANTS);
  const quoteNo = `QT-${2025}-${randInt(10000,99999)}`;
  const bookingId = `BK-${randInt(100000,999999)}`;
  const invoiceNo = `INV-${randInt(100000,999999)}`;
  const custPrice = randInt(2500, 3500) * qtyM3;
  const dealerPrice = Math.round(custPrice * 0.88);
  const margin = custPrice - dealerPrice;

  const statesByType = {
    SITE_PENDING: 'PENDING_APPROVAL',
    QUOTE_SENT: 'NEW',
    ADD_PRODUCT: 'PROCESSING',
    BOOKING_REQUEST: 'PENDING_APPROVAL',
    BOOKING_CONFIRMED: 'CONFIRMED',
    INVOICE_CREATED: 'INVOICED',
    PAYMENT_PENDING: 'PENDING_APPROVAL',
    PAYMENT_CONFIRMED: 'PAID',
    DISPATCH_LIVE: 'DISPATCHED',
    CUSTOMER_ACTION: 'NEW',
    POUR_REMINDER: 'PROCESSING',
  };

  const sevByType = {
    SITE_PENDING: 'INFO',
    QUOTE_SENT: 'INFO',
    ADD_PRODUCT: 'WARN',
    BOOKING_REQUEST: 'WARN',
    BOOKING_CONFIRMED: 'INFO',
    INVOICE_CREATED: 'INFO',
    PAYMENT_PENDING: 'ALERT',
    PAYMENT_CONFIRMED: 'INFO',
    DISPATCH_LIVE: 'ALERT',
    CUSTOMER_ACTION: 'WARN',
    POUR_REMINDER: 'ALERT',
  };

  const keyDetailByType = {
    SITE_PENDING: `‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà: ${prov} ‚Äî ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å ${randInt(1,500)} ‡∏¢‡∏π‡∏ô‡∏¥‡∏ï`,
    QUOTE_SENT: `${product} √ó ${qtyM3} ‡∏Ñ‡∏¥‡∏ß ‚Äî ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${custPrice.toLocaleString()} / Dealer ${dealerPrice.toLocaleString()}`,
    ADD_PRODUCT: `‡πÄ‡∏û‡∏¥‡πà‡∏° ${product} √ó ${randInt(1,5)} ‡∏Ñ‡∏¥‡∏ß ‡πÄ‡∏Ç‡πâ‡∏≤ ${quoteNo}`,
    BOOKING_REQUEST: `‡∏à‡∏≠‡∏á ${product} √ó ${qtyM3} ‡∏Ñ‡∏¥‡∏ß ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${ts.toLocaleDateString('th-TH')}`,
    BOOKING_CONFIRMED: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó ${qtyM3} ‡∏Ñ‡∏¥‡∏ß ‚Äî ${plant}`,
    INVOICE_CREATED: `${invoiceNo} ‡∏£‡∏ß‡∏° ${formatMoney(custPrice)}`,
    PAYMENT_PENDING: `‡∏£‡∏≠‡∏î‡∏µ‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${formatMoney(custPrice)}`,
    PAYMENT_CONFIRMED: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${formatMoney(custPrice)} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`,
    DISPATCH_LIVE: `üöõ ‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${randInt(1,5)} ‡∏Ñ‡∏±‡∏ô ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° LIVE`,
    CUSTOMER_ACTION: `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î "${randFrom(['‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏à‡∏ô‡∏ó.','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏ó','‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤'])}"`,
    POUR_REMINDER: `‡πÄ‡∏ó‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡πÉ‡∏ô ${randInt(1,120)} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Äî T-2h reminder`,
  };

  return {
    id: `EVT-${String(idCounter++).padStart(5,'0')}`,
    ts: ts.toISOString(),
    eventType: type,
    severity: sevByType[type],
    isNew: isNew,
    customer: { lineName: custName, phone: custPhone },
    site: {
      siteCode,
      projectName: `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${prov} ‡πÄ‡∏£‡∏™‡∏ã‡∏¥‡πÄ‡∏î‡∏ô‡∏ã‡πå ${randInt(1,10)}`,
      province: prov,
      mapUrl: `https://maps.google.com?q=${prov}`
    },
    quote: { quoteNo, itemsSummary: `${product} √ó ${qtyM3}`, customerPrice: custPrice, dealerPrice, margin },
    booking: { bookingId, pourDateTime: new Date(ts.getTime() + 86400000 * randInt(1,7)).toISOString(), product, qtyM3, truckType: `‡∏£‡∏ñ ${randInt(6,10)} ‡∏Ñ‡∏¥‡∏ß`, plant },
    invoice: { invoiceNo, total: custPrice, status: '‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' },
    status: { currentState: statesByType[type], previousState: 'NEW' },
    keyDetail: keyDetailByType[type],
    isDone: false,
    doneBy: null, doneAt: null,
  };
}

function generateMockData() {
  const events = [];
  // 60 events spread across today
  for (let i = 0; i < 60; i++) {
    events.push(genEvent(i * 0.13));
  }
  // Sort newest first
  events.sort((a,b) => new Date(b.ts) - new Date(a.ts));
  return events;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function doLogin() {
  const user = document.getElementById('loginUser').value;
  const pass = document.getElementById('loginPass').value;
  if (user === 'dealer01' && pass === '1234') {
    currentUser = { name: user, role: 'Dealer', token: 'mock-bearer-abc123' };
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initApp();
  } else {
    document.getElementById('loginError').textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
  }
}
function doLogout() {
  currentUser = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  clearInterval(autoRefreshTimer);
}
document.addEventListener('keydown', e => { if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') doLogin(); });

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initApp() {
  updateHeaderDate();
  allEvents = generateMockData();
  applyFilters();
  renderKpis();
  setInterval_();
}

function updateHeaderDate() {
  const now = new Date();
  document.getElementById('headerDate').textContent = now.toLocaleDateString('th-TH', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  document.getElementById('lastUpdated').textContent = fmtDateTime(now);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REFRESH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function doRefresh() {
  const prevIds = new Set(allEvents.map(e => e.id));
  // Simulate: add 0‚Äì3 new events
  const newCount = randInt(0, 3);
  const newEvts = [];
  for (let i = 0; i < newCount; i++) {
    const e = genEvent(0, true);
    newEvts.push(e);
  }
  // Update some existing events
  allEvents.forEach(e => {
    if (Math.random() < 0.05) {
      e.isChanged = true;
    }
  });
  allEvents = [...newEvts, ...allEvents];
  newEventIds = new Set(newEvts.map(e => e.id));
  applyFilters();
  renderKpis();
  updateHeaderDate();
  if (newCount > 0) {
    showToast(`üîî ${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤`, 'success');
  } else {
    showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
  }
  const badge = document.getElementById('newBadge');
  if (newCount > 0) {
    badge.style.display = 'inline-flex';
    badge.textContent = `${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà`;
  } else {
    badge.style.display = 'none';
  }
}

function setInterval_() {
  clearInterval(autoRefreshTimer);
  const val = parseInt(document.getElementById('intervalSelect').value);
  if (val > 0) {
    autoRefreshTimer = setInterval(doRefresh, val * 1000);
  }
}

function toggleChanged() {
  showChangedOnly = !showChangedOnly;
  const btn = document.getElementById('changedToggle');
  btn.classList.toggle('active', showChangedOnly);
  applyFilters();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILTERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getActiveSevs() {
  return [...document.querySelectorAll('.filter-chip.active[data-sev]')].map(c => c.dataset.sev);
}
function toggleChip(el, group) {
  el.classList.toggle('active');
  applyFilters();
}

function applyFilters() {
  const fProv = document.getElementById('fProv').value.toLowerCase().trim();
  const fType = document.getElementById('fType').value;
  const fSearch = document.getElementById('fSearch').value.toLowerCase().trim();
  const fTime = document.getElementById('fTime').value;
  const activeSevs = getActiveSevs();
  const now = new Date();

  filteredEvents = allEvents.filter(e => {
    if (showChangedOnly && !e.isNew && !e.isChanged) return false;
    if (!activeSevs.includes(e.severity)) return false;
    if (fType && e.eventType !== fType) return false;
    if (fProv && !e.site.province.includes(fProv) && !e.site.province.toLowerCase().includes(fProv)) return false;
    if (fTime !== 'all') {
      const mins = parseInt(fTime);
      if ((now - new Date(e.ts)) > mins * 60000) return false;
    }
    if (fSearch) {
      const hay = [e.site.siteCode, e.quote.quoteNo, e.customer.lineName, e.customer.phone, e.site.projectName].join(' ').toLowerCase();
      if (!hay.includes(fSearch)) return false;
    }
    return true;
  });

  currentPage = 1;
  renderTable();
  renderPagination();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KPI RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderKpis() {
  const today = new Date().toDateString();
  const kpis = [
    { label: '‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà', type: 'alert', filter: 'SITE_PENDING', val: allEvents.filter(e=>e.eventType==='SITE_PENDING').length, cls: 'warn' },
    { label: 'Quotes ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', type: 'info', filter: 'QUOTE_SENT', val: allEvents.filter(e=>e.eventType==='QUOTE_SENT').length, cls: '' },
    { label: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', type: 'warn', filter: 'ADD_PRODUCT', val: allEvents.filter(e=>e.eventType==='ADD_PRODUCT').length, cls: 'warn' },
    { label: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≠‡∏á', type: 'alert', filter: 'BOOKING_REQUEST', val: allEvents.filter(e=>e.eventType==='BOOKING_REQUEST').length, cls: 'alert' },
    { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó‡πÅ‡∏•‡πâ‡∏ß', type: 'success', filter: 'BOOKING_CONFIRMED', val: allEvents.filter(e=>e.eventType==='BOOKING_CONFIRMED').length, cls: 'success' },
    { label: '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞', type: 'alert', filter: 'PAYMENT_PENDING', val: allEvents.filter(e=>e.eventType==='PAYMENT_PENDING').length, cls: 'alert' },
    { label: '‡πÄ‡∏ó <24h', type: 'warn', filter: 'POUR_REMINDER', val: allEvents.filter(e=>e.eventType==='POUR_REMINDER').length, cls: 'warn' },
    { label: 'Dispatch Live', type: 'alert', filter: 'DISPATCH_LIVE', val: allEvents.filter(e=>e.eventType==='DISPATCH_LIVE').length, cls: 'alert' },
  ];

  const strip = document.getElementById('kpiStrip');
  strip.innerHTML = kpis.map((k,i) => `
    <div class="kpi-card ${k.cls} ${selectedKpi===k.filter?'selected':''}" onclick="filterByKpi('${k.filter}',this)">
      <div class="kpi-value">${k.val}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

function filterByKpi(type, el) {
  if (selectedKpi === type) {
    selectedKpi = null;
    document.getElementById('fType').value = '';
  } else {
    selectedKpi = type;
    document.getElementById('fType').value = type;
  }
  document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('selected'));
  if (selectedKpi) el.classList.add('selected');
  applyFilters();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABLE RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderTable() {
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageEvents = filteredEvents.slice(start, start + PAGE_SIZE);
  const tbody = document.getElementById('actBody');

  document.getElementById('tableCount').textContent = `${filteredEvents.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

  if (pageEvents.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="emoji">üì≠</div><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3><p>‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô filter ‡∏´‡∏£‡∏∑‡∏≠ refresh ‡πÉ‡∏´‡∏°‡πà</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = pageEvents.map(e => {
    const ts = new Date(e.ts);
    const isNew = newEventIds.has(e.id);
    const evtInfo = EVENT_TYPES[e.eventType] || { label: e.eventType, icon: '‚Ä¢' };
    const stateInfo = STATES[e.status.currentState] || { label: e.status.currentState, cls: 'state-new' };
    const isPending = e.status.currentState === 'PENDING_APPROVAL';
    const isDone = e.isDone;

    return `
    <tr class="${isNew?'is-new':''} ${selectedEventId===e.id?'selected-row':''}" onclick="openDrawer('${e.id}')">
      <td class="time-cell">
        ${fmtTime(ts)}
        ${isNew?`<span class="new-badge">‚óè NEW</span>`:''}
      </td>
      <td><span class="sev-chip sev-${e.severity.toLowerCase()}">${e.severity==='ALERT'?'üî¥':e.severity==='WARN'?'üü°':'üîµ'} ${e.severity}</span></td>
      <td class="event-type-cell">
        ${evtInfo.icon} ${evtInfo.label}
        <span>#${e.id}</span>
      </td>
      <td class="customer-cell">
        <div class="customer-name">${escHtml(e.customer.lineName)}</div>
        <div class="customer-phone">${e.customer.phone} <button class="copy-btn" onclick="event.stopPropagation();copyText('${e.customer.phone}')">Copy</button></div>
      </td>
      <td class="site-cell">
        <div class="site-code">${e.site.siteCode}</div>
        <div class="site-name">${escHtml(e.site.projectName)}</div>
        <div class="site-prov">üìç ${e.site.province}</div>
        <button class="map-btn" onclick="event.stopPropagation();openMap('${e.site.mapUrl}')">üó∫ Map</button>
      </td>
      <td class="key-detail">${escHtml(e.keyDetail)}</td>
      <td><span class="state-chip ${stateInfo.cls}">${isDone?'‚úì Done':stateInfo.label}</span></td>
      <td><div class="action-btns" onclick="event.stopPropagation()">
        <button class="act-btn view" title="‡∏î‡∏π Detail" onclick="openDrawer('${e.id}')">üëÅ</button>
        <button class="act-btn call" title="‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" onclick="window.open('tel:${e.customer.phone}')">üìû</button>
        <button class="act-btn line" title="‡πÄ‡∏õ‡∏¥‡∏î LINE" onclick="window.open('https://line.me/')">üí¨</button>
        ${isPending && !isDone ? `
          <button class="act-btn approve" title="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" onclick="quickApprove('${e.id}')">‚úÖ</button>
          <button class="act-btn reject" title="‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" onclick="quickReject('${e.id}')">‚ùå</button>
        ` : ''}
        ${!isDone ? `<button class="act-btn done" title="Mark Done" onclick="markDone('${e.id}')">‚òë</button>` : ''}
      </div></td>
    </tr>`;
  }).join('');
}

function renderPagination() {
  const totalPages = Math.ceil(filteredEvents.length / PAGE_SIZE);
  const pg = document.getElementById('pagination');
  if (totalPages <= 1) { pg.innerHTML = ''; return; }

  let html = `<button class="page-btn" onclick="goPage(${currentPage-1})" ${currentPage<=1?'disabled':''}>‚Äπ</button>`;
  for (let p = Math.max(1, currentPage-2); p <= Math.min(totalPages, currentPage+2); p++) {
    html += `<button class="page-btn ${p===currentPage?'active':''}" onclick="goPage(${p})">${p}</button>`;
  }
  html += `<button class="page-btn" onclick="goPage(${currentPage+1})" ${currentPage>=totalPages?'disabled':''}>‚Ä∫</button>`;
  html += `<span class="page-info">‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}/${totalPages} | ${filteredEvents.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
  pg.innerHTML = html;
}

function goPage(p) {
  const totalPages = Math.ceil(filteredEvents.length / PAGE_SIZE);
  if (p < 1 || p > totalPages) return;
  currentPage = p;
  renderTable();
  renderPagination();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAWER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openDrawer(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  selectedEventId = id;
  renderTable();

  const evtInfo = EVENT_TYPES[e.eventType] || { label: e.eventType, icon: '‚Ä¢' };
  const stateInfo = STATES[e.status.currentState] || { label: e.status.currentState, cls: 'state-new' };
  const isPending = e.status.currentState === 'PENDING_APPROVAL';

  document.getElementById('drawerTitle').textContent = `${evtInfo.icon} ${evtInfo.label}`;
  document.getElementById('drawerSubtitle').textContent = `${e.id} ¬∑ ${new Date(e.ts).toLocaleString('th-TH')}`;

  // Build history for same site
  const siteHistory = allEvents.filter(x => x.site.siteCode === e.site.siteCode && x.id !== e.id).slice(0,10);

  document.getElementById('drawerBody').innerHTML = `
    <!-- QUICK ACTIONS -->
    <div>
      <div class="drawer-section-title">Quick Actions</div>
      <div class="quick-actions">
        ${isPending && !e.isDone ? `
          <button class="qa-btn qa-approve" onclick="quickApprove('${e.id}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="qa-btn qa-reject" onclick="quickReject('${e.id}')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        `:''}
        ${e.eventType === 'INVOICE_CREATED' || e.eventType === 'QUOTE_SENT' ? `<button class="qa-btn qa-invoice" onclick="createInvoice('${e.id}')">üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice</button>` : ''}
        ${e.eventType === 'PAYMENT_PENDING' ? `<button class="qa-btn qa-approve" onclick="confirmPayment('${e.id}')">üí≥ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>` : ''}
        ${e.eventType === 'BOOKING_REQUEST' ? `<button class="qa-btn qa-slots" onclick="suggestSlots('${e.id}')">üìÖ ‡πÄ‡∏™‡∏ô‡∏≠ 3 Slots</button>` : ''}
        ${!e.isDone ? `<button class="qa-btn qa-done" onclick="markDone('${e.id}')">‚òë Mark Done</button>` : `<span style="font-size:12px;color:var(--success)">‚úì Done ‡πÇ‡∏î‡∏¢ ${e.doneBy} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${e.doneAt}</span>` }
      </div>
    </div>

    <!-- CUSTOMER & SITE -->
    <div>
      <div class="drawer-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ & ‡πÑ‡∏ã‡∏ï‡πå</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="info-val">${escHtml(e.customer.lineName)}</div></div>
        <div class="info-item"><div class="info-key">‡πÄ‡∏ö‡∏≠‡∏£‡πå</div><div class="info-val mono"><a href="tel:${e.customer.phone}" style="color:var(--primary)">${e.customer.phone}</a></div></div>
        <div class="info-item"><div class="info-key">Site Code</div><div class="info-val mono" style="color:var(--primary)">${e.site.siteCode}</div></div>
        <div class="info-item"><div class="info-key">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</div><div class="info-val">üìç ${e.site.province}</div></div>
        <div class="info-item info-item-wide" style="grid-column:1/-1"><div class="info-key">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div><div class="info-val">${escHtml(e.site.projectName)}</div></div>
      </div>
    </div>

    <!-- QUOTE INFO -->
    <div>
      <div class="drawer-section-title">Quotation</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">Quote No</div><div class="info-val mono">${e.quote.quoteNo}</div></div>
        <div class="info-item"><div class="info-key">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><div class="info-val">${escHtml(e.quote.itemsSummary)}</div></div>
        <div class="info-item"><div class="info-key">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="info-val price">${e.quote.customerPrice.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">Dealer Price</div><div class="info-val price">${e.quote.dealerPrice.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">Margin</div><div class="info-val margin">+${e.quote.margin.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div class="info-val"><span class="state-chip ${stateInfo.cls}">${stateInfo.label}</span></div></div>
      </div>
    </div>

    <!-- BOOKING -->
    <div>
      <div class="drawer-section-title">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á / ‡πÄ‡∏ó</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">Booking ID</div><div class="info-val mono">${e.booking.bookingId}</div></div>
        <div class="info-item"><div class="info-key">‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó</div><div class="info-val">${new Date(e.booking.pourDateTime).toLocaleString('th-TH',{dateStyle:'medium',timeStyle:'short'})}</div></div>
        <div class="info-item"><div class="info-key">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</div><div class="info-val">${e.booking.qtyM3} ‡∏•‡∏ö.‡∏°.</div></div>
        <div class="info-item"><div class="info-key">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</div><div class="info-val">${e.booking.truckType}</div></div>
        <div class="info-item info-item-wide" style="grid-column:1/-1"><div class="info-key">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</div><div class="info-val">üè≠ ${e.booking.plant}</div></div>
      </div>
    </div>

    <!-- INVOICE -->
    <div>
      <div class="drawer-section-title">Invoice / ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">Invoice No</div><div class="info-val mono">${e.invoice.invoiceNo}</div></div>
        <div class="info-item"><div class="info-key">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div><div class="info-val price">${e.invoice.total.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div class="info-val">${e.invoice.status}</div></div>
      </div>
    </div>

    <!-- TIMELINE -->
    <div>
      <div class="drawer-section-title">Timeline ‡∏Ç‡∏≠‡∏á Event ‡∏ô‡∏µ‡πâ</div>
      <div class="timeline">
        <div class="timeline-step">
          <div class="step-dot done">‚úì</div>
          <div class="step-content">
            <div class="step-title">Event ‡∏™‡∏£‡πâ‡∏≤‡∏á</div>
            <div class="step-time">${new Date(e.ts).toLocaleString('th-TH')}</div>
          </div>
        </div>
        <div class="timeline-step">
          <div class="step-dot ${e.status.currentState === 'PENDING_APPROVAL' ? 'active' : 'done'}">
            ${e.status.currentState === 'PENDING_APPROVAL' ? '‚è≥' : '‚úì'}
          </div>
          <div class="step-content">
            <div class="step-title">${e.status.currentState === 'PENDING_APPROVAL' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'}</div>
            <div class="step-time">${stateInfo.label}</div>
          </div>
        </div>
        <div class="timeline-step">
          <div class="step-dot pending">‚Üí</div>
          <div class="step-content">
            <div class="step-title">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
            <div class="step-note">‡∏£‡∏≠ Dealer ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SITE HISTORY -->
    <div>
      <div class="drawer-section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏ã‡∏ï‡πå ${e.site.siteCode} (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${siteHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
      ${siteHistory.length === 0 ? '<p style="font-size:12px;color:var(--text-muted)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>' : `
      <table class="history-table">
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody>${siteHistory.map(h => `
          <tr onclick="openDrawer('${h.id}')" style="cursor:pointer">
            <td style="font-family:var(--mono);font-size:10px">${fmtTime(new Date(h.ts))}</td>
            <td>${EVENT_TYPES[h.eventType]?.icon||''} ${EVENT_TYPES[h.eventType]?.label||h.eventType}</td>
            <td><span class="state-chip ${STATES[h.status.currentState]?.cls||'state-new'}" style="font-size:9px;padding:2px 6px">${STATES[h.status.currentState]?.label||h.status.currentState}</span></td>
          </tr>
        `).join('')}</tbody>
      </table>`}
    </div>
  `;

  document.getElementById('drawerOverlay').classList.add('open');
  document.getElementById('rightDrawer').classList.add('open');
  document.getElementById('mainContent').classList.add('drawer-open');
}

function closeDrawer() {
  selectedEventId = null;
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('rightDrawer').classList.remove('open');
  document.getElementById('mainContent').classList.remove('drawer-open');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ACTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function quickApprove(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  e.status.currentState = 'APPROVED';
  e.isDone = true;
  addAudit('APPROVE', id, `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${e.eventType}`);
  showToast(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
  renderTable(); renderKpis();
  if (selectedEventId === id) openDrawer(id);
}
function quickReject(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  e.status.currentState = 'REJECTED';
  addAudit('REJECT', id, `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${e.eventType}`);
  showToast(`‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${id}`, 'warn');
  renderTable(); renderKpis();
  if (selectedEventId === id) openDrawer(id);
}
function markDone(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  e.isDone = true;
  e.doneBy = currentUser?.name || 'dealer01';
  e.doneAt = new Date().toLocaleTimeString('th-TH');
  addAudit('MARK_DONE', id, `‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ${e.eventType}`);
  showToast(`‚òë Mark Done: ${id}`, 'success');
  renderTable();
  if (selectedEventId === id) openDrawer(id);
}
function createInvoice(id) {
  addAudit('CREATE_INVOICE', id, '‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice');
  showToast('üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
}
function confirmPayment(id) {
  const e = allEvents.find(x => x.id === id);
  if (e) { e.status.currentState = 'PAID'; e.isDone = true; }
  addAudit('CONFIRM_PAYMENT', id, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô');
  showToast('üí≥ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
  renderTable(); renderKpis();
  if (selectedEventId === id) openDrawer(id);
}
function suggestSlots(id) {
  addAudit('SUGGEST_SLOTS', id, '‡πÄ‡∏™‡∏ô‡∏≠ 3 time slots');
  showToast('üìÖ ‡∏™‡πà‡∏á 3 Slots ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUDIT LOG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addAudit(action, eventId, summary) {
  auditLog.unshift({ action, eventId, summary, user: currentUser?.name, ts: new Date().toLocaleString('th-TH') });
}
function openAuditLog() {
  const body = document.getElementById('auditBody');
  if (auditLog.length === 0) {
    body.innerHTML = '<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:20px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>';
  } else {
    body.innerHTML = auditLog.map(a => `
      <div class="audit-entry">
        <div><span class="audit-action">${a.action}</span> ‚Äî ${escHtml(a.summary)}</div>
        <div class="audit-meta">Event: ${a.eventId} ¬∑ ‡πÇ‡∏î‡∏¢: ${a.user} ¬∑ ${a.ts}</div>
      </div>
    `).join('');
  }
  document.getElementById('auditModal').classList.add('open');
}
function closeAuditLog() { document.getElementById('auditModal').classList.remove('open'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILITIES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openMap(url) { window.open(url, '_blank'); }
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'));
}
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function showToast(msg, type = '') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.classList.add('out'); setTimeout(() => t.remove(), 300); }, 2800);
}

// Close audit on overlay click
document.getElementById('auditModal').addEventListener('click', function(e) {
  if (e.target === this) closeAuditLog();
});

// Clock update
setInterval(() => {
  if (currentUser) updateHeaderDate();
}, 1000);
</script>
</body>
</html>
