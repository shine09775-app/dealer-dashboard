<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dealer Daily Activity Dashboard ‚Äî ‡∏ö.‡∏ô‡∏ß‡∏ä‡∏±‡∏¢ ‡πÅ‡∏°‡∏ó‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏• ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏Å.</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="./CPACTheme.css">
<style>
/* ‚îÄ‚îÄ‚îÄ ROOT VARIABLES (CPACTheme inspired) ‚îÄ‚îÄ‚îÄ */
:root {
  --primary: #189cd8;
  --primary-dark: #127eae;
  --primary-light: #6fc5ed;
  --accent: #6fc5ed;
  --accent2: #e6f3fb;
  --success: #0fb36a;
  --success-bg: #e9f9f1;
  --warn: #f59e0b;
  --warn-bg: #fff6e8;
  --alert: #e53955;
  --alert-bg: #fff1f4;
  --info: #189cd8;
  --info-bg: #e6f3fb;
  --surface: #FFFFFF;
  --surface2: #f2f9fd;
  --surface3: #e6f3fb;
  --border: #b5dbf0;
  --border-light: #d9edff;
  --text: #0f2438;
  --text-muted: #4f6b80;
  --text-light: #7d95ab;
  --shadow: 0 14px 36px rgba(24,156,216,0.12);
  --shadow-md: 0 10px 26px rgba(24,156,216,0.18);
  --shadow-lg: 0 24px 48px rgba(24,156,216,0.22);
  --radius: 8px;
  --radius-sm: 5px;
  --radius-lg: 14px;
  --font: 'IBM Plex Sans Thai', sans-serif;
  --mono: 'IBM Plex Mono', monospace;
  --header-h: 64px;
  --filter-h: 56px;
  --kpi-h: 100px;
  --drawer-w: 480px;
}

/* ‚îÄ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; }
body {
  font-family: var(--font);
  background:
    radial-gradient(1200px 1200px at 12% 18%, rgba(24,156,216,0.06), transparent 38%),
    radial-gradient(1000px 1000px at 82% 4%, rgba(24,156,216,0.05), transparent 40%),
    var(--surface2);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}
button { font-family: var(--font); cursor: pointer; border: none; background: none; }
input, select { font-family: var(--font); }
a { color: inherit; text-decoration: none; }

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--surface2); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.app-header {
  position: sticky; top: 0; z-index: 100;
  height: var(--header-h);
  background: var(--primary);
  display: flex; align-items: center;
  padding: 0 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  gap: 16px;
}
.header-logo {
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
}
.header-logo-img {
  width: 56px; height: 36px;
  border-radius: 0;
  object-fit: contain;
  background: transparent;
  border: none;
  padding: 0;
}
.header-title {
  color: white;
  font-size: 15px; font-weight: 700;
  line-height: 1.2;
}
.header-subtitle {
  color: rgba(255,255,255,0.82);
  font-size: 11px; font-weight: 400;
}
.header-spacer { flex: 1; }
.header-time {
  color: rgba(255,255,255,0.75);
  font-size: 11px;
  font-family: var(--mono);
  text-align: right;
  line-height: 1.5;
}
.header-time strong { color: white; font-size: 13px; }
.header-controls {
  display: flex; align-items: center; gap: 8px;
  flex-shrink: 0;
}
.header-controls select {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.25);
  color: white; border-radius: var(--radius-sm);
  padding: 6px 10px; font-size: 12px;
  outline: none; cursor: pointer;
}
.header-controls select option { background: var(--primary-dark); color: white; }
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px; border-radius: var(--radius-sm);
  font-size: 12px; font-weight: 600;
  transition: all 0.15s; cursor: pointer; border: none;
}
.btn-primary { background: white; color: var(--primary); }
.btn-primary:hover { background: var(--accent2); }
.btn-ghost {
  background: rgba(255,255,255,0.12);
  color: white;
  border: 1px solid rgba(255,255,255,0.25);
}
.btn-ghost:hover { background: rgba(255,255,255,0.22); }
.btn-ghost.active { background: rgba(255,255,255,0.28); }

/* ‚îÄ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ‚îÄ */
.filter-bar {
  position: sticky; top: var(--header-h); z-index: 90;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 8px 20px;
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.filter-group {
  display: flex; align-items: center; gap: 4px;
}
.filter-label {
  font-size: 11px; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  white-space: nowrap;
}
.filter-select, .filter-input {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 5px 10px; font-size: 12px; color: var(--text);
  outline: none; height: 30px;
  transition: border-color 0.15s;
}
.filter-select:focus, .filter-input:focus { border-color: var(--primary); }
.filter-input { width: 180px; }
.filter-divider {
  width: 1px; height: 24px; background: var(--border);
  margin: 0 4px; flex-shrink: 0;
}
.filter-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 10px;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  font-size: 11px; font-weight: 600;
  background: var(--surface); color: var(--text-muted);
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.filter-chip:hover { border-color: var(--primary-light); color: var(--primary); }
.filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }

/* ‚îÄ‚îÄ‚îÄ KPI STRIP ‚îÄ‚îÄ‚îÄ */
.kpi-strip {
  padding: 12px 20px;
  display: flex; gap: 10px; overflow-x: auto;
  background: var(--surface);
  border-bottom: 1px solid var(--border-light);
}
.kpi-card {
  flex: 0 0 auto;
  min-width: 120px;
  background: var(--surface2);
  border: 1.5px solid var(--border-light);
  border-radius: var(--radius);
  padding: 10px 14px;
  cursor: pointer; transition: all 0.15s;
  position: relative; overflow: hidden;
}
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 3px; background: var(--primary);
}
.kpi-card.warn::before { background: var(--warn); }
.kpi-card.alert::before { background: var(--alert); }
.kpi-card.success::before { background: var(--success); }
.kpi-card:hover { border-color: var(--primary-light); box-shadow: var(--shadow); transform: translateY(-1px); }
.kpi-card.selected { border-color: var(--primary); background: var(--info-bg); }
.kpi-value {
  font-size: 22px; font-weight: 700; color: var(--primary);
  font-family: var(--mono); line-height: 1;
}
.kpi-card.warn .kpi-value { color: var(--warn); }
.kpi-card.alert .kpi-value { color: var(--alert); }
.kpi-card.success .kpi-value { color: var(--success); }
.kpi-label {
  font-size: 10px; font-weight: 600; color: var(--text-muted);
  margin-top: 4px; line-height: 1.3; text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.main-content {
  padding: 12px 20px;
  transition: margin-right 0.3s;
}
.main-content.drawer-open { margin-right: var(--drawer-w); }

/* ‚îÄ‚îÄ‚îÄ ACTIVITY TABLE ‚îÄ‚îÄ‚îÄ */
.table-wrap {
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow);
}
.table-tabs {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-light);
  background: linear-gradient(180deg, var(--surface2), var(--surface));
}
.table-tab {
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-muted);
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 700;
  line-height: 1;
}
.table-tab:hover { border-color: var(--primary-light); color: var(--primary); }
.table-tab.active {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
}
.table-header-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-light);
  background: var(--surface);
}
.table-panel { display: none; }
.table-panel.active { display: block; }
.table-title { font-size: 13px; font-weight: 700; color: var(--text); }
.table-count {
  font-size: 11px; color: var(--text-muted);
  background: var(--surface2); border-radius: 20px;
  padding: 2px 8px; font-family: var(--mono);
}
.table-spacer { flex: 1; }
.new-badge-indicator {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 11px; font-weight: 600; color: var(--success);
  background: var(--success-bg); border-radius: 20px;
  padding: 3px 10px;
}
.new-badge-indicator::before {
  content: ''; width: 6px; height: 6px;
  background: var(--success); border-radius: 50%;
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.85); }
}

table {
  width: 100%; border-collapse: collapse;
  table-layout: fixed;
}
thead { position: static; }
#actTable thead { position: static; }
thead tr { background: var(--surface3); }
th {
  padding: 8px 12px;
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.6px;
  color: var(--text-muted); text-align: left;
  border-bottom: 2px solid var(--border);
  white-space: nowrap; overflow: hidden;
}
#actTable th:nth-child(1) { width: 56px; }
#actTable th:nth-child(2) { width: 70px; }
#actTable th:nth-child(3) { width: 140px; }
#actTable th:nth-child(4) { width: 150px; }
#actTable th:nth-child(5) { width: 170px; }
#actTable th:nth-child(6) { width: auto; }
#actTable th:nth-child(7) { width: 120px; }
#actTable th:nth-child(8) { width: 160px; }

tbody tr {
  border-bottom: 1px solid var(--border-light);
  transition: background 0.15s;
  cursor: pointer;
}
tbody tr:hover { background: var(--surface2); }
tbody tr.is-new {
  background: linear-gradient(90deg, rgba(0,135,90,0.06) 0%, transparent 60%);
  animation: fadeNew 3s ease forwards;
}
@keyframes fadeNew {
  0% { background: rgba(0,135,90,0.12); }
  100% { background: transparent; }
}
tbody tr.is-new td:first-child::before {
  content: ''; display: block;
  width: 3px; height: 100%;
  background: var(--success);
  position: absolute; left: 0; top: 0;
}
tbody tr td:first-child { position: relative; }
tbody tr.selected-row { background: var(--info-bg) !important; }
td {
  padding: 8px 12px;
  font-size: 12px; color: var(--text);
  vertical-align: middle;
  overflow: hidden;
}
.time-cell {
  font-family: var(--mono);
  font-size: 12px; font-weight: 600;
  color: var(--text-muted);
  white-space: nowrap;
}
#pourTable { table-layout: auto; }
#pourTable th, #pourTable td { white-space: nowrap; }
#pourTable thead {
  position: static;
}
.num-cell { text-align: right; font-family: var(--mono); }
.num-link {
  color: var(--primary);
  text-decoration: underline;
  font-weight: 700;
}
.num-link:hover { color: var(--primary-dark); }
.status-pill {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  background: var(--surface2);
  border: 1px solid var(--border);
}
.pump-pill {
  display: inline-block;
  min-width: 44px;
  text-align: center;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 11px;
  font-weight: 700;
  color: #fff;
  background: var(--text-light);
}
.pump-pill.on { background: var(--warn); }
.time-cell .new-badge {
  display: block;
  font-size: 9px; font-weight: 700;
  color: var(--success); letter-spacing: 0.5px;
  margin-top: 1px;
}

/* SEVERITY CHIP */
.sev-chip {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 3px 8px; border-radius: 20px;
  font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
  white-space: nowrap;
}
.sev-alert { background: var(--alert-bg); color: var(--alert); }
.sev-warn { background: var(--warn-bg); color: var(--warn); }
.sev-info { background: var(--info-bg); color: var(--info); }

/* EVENT TYPE */
.event-type-cell { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.3; }
.event-type-cell span { display: block; font-size: 10px; font-weight: 400; color: var(--text-muted); margin-top: 1px; }

/* CUSTOMER */
.customer-cell { line-height: 1.4; }
.customer-name { font-weight: 600; font-size: 12px; }
.customer-phone { font-size: 11px; color: var(--text-muted); font-family: var(--mono); }
.copy-btn {
  display: inline-flex; align-items: center;
  padding: 2px 6px; margin-left: 4px;
  border-radius: 4px; font-size: 9px; font-weight: 600;
  background: var(--surface2); color: var(--text-muted);
  border: 1px solid var(--border); cursor: pointer;
  transition: all 0.15s; white-space: nowrap;
}
.copy-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

/* SITE */
.site-cell { line-height: 1.4; }
.site-code { font-family: var(--mono); font-weight: 700; font-size: 12px; color: var(--primary); }
.site-name { font-size: 11px; color: var(--text); }
.site-prov { font-size: 10px; color: var(--text-muted); }
.map-btn {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 6px; margin-top: 2px;
  border-radius: 4px; font-size: 9px; font-weight: 600;
  background: var(--accent2); color: var(--primary);
  border: 1px solid #b3d7f0; cursor: pointer;
  transition: all 0.15s;
}
.map-btn:hover { background: var(--primary); color: white; }

/* KEY DETAIL */
.key-detail {
  font-size: 12px; color: var(--text);
  line-height: 1.4; max-height: 2.8em; overflow: hidden;
}
.key-detail strong { color: var(--primary); }

/* STATE CHIP */
.state-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 10px; border-radius: 20px;
  font-size: 10px; font-weight: 700; white-space: nowrap;
}
.state-pending { background: var(--warn-bg); color: var(--warn); }
.state-approved { background: var(--success-bg); color: var(--success); }
.state-confirmed { background: var(--success-bg); color: var(--success); }
.state-new { background: var(--info-bg); color: var(--primary); }
.state-processing { background: #EDE7F6; color: #512DA8; }
.state-invoiced { background: #E8EAF6; color: #3949AB; }
.state-paid { background: var(--success-bg); color: var(--success); }
.state-rejected { background: var(--alert-bg); color: var(--alert); }
.state-dispatched { background: #E0F7FA; color: #00838F; }
.state-done { background: var(--surface3); color: var(--text-muted); }

/* ACTIONS */
.action-btns {
  display: flex; gap: 4px; flex-wrap: nowrap; align-items: center;
}
.act-btn {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; border-radius: 6px;
  font-size: 13px; transition: all 0.15s; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface);
  position: relative;
}
.act-btn:hover { transform: scale(1.15); box-shadow: var(--shadow); z-index: 1; }
.act-btn.view:hover { background: var(--primary); border-color: var(--primary); }
.act-btn.call:hover { background: var(--success); border-color: var(--success); }
.act-btn.line:hover { background: #06C755; border-color: #06C755; }
.act-btn.approve:hover { background: var(--success); border-color: var(--success); }
.act-btn.reject:hover { background: var(--alert); border-color: var(--alert); }
.act-btn.done:hover { background: var(--text-muted); border-color: var(--text-muted); }
.act-btn:hover { color: white; }
.act-btn[title]:hover::after {
  content: attr(title);
  position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8); color: white;
  padding: 3px 8px; border-radius: 4px; font-size: 10px;
  white-space: nowrap; pointer-events: none; z-index: 999;
  font-family: var(--font);
}

/* ‚îÄ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ‚îÄ */
.pagination {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px; border-top: 1px solid var(--border-light);
  background: var(--surface);
}
.page-btn {
  padding: 5px 12px; border-radius: var(--radius-sm);
  font-size: 12px; font-weight: 600;
  border: 1px solid var(--border); background: var(--surface);
  color: var(--text); cursor: pointer; transition: all 0.15s;
}
.page-btn:hover, .page-btn.active {
  background: var(--primary); color: white; border-color: var(--primary);
}
.page-info { font-size: 11px; color: var(--text-muted); font-family: var(--mono); }

/* ‚îÄ‚îÄ‚îÄ RIGHT DRAWER ‚îÄ‚îÄ‚îÄ */
.drawer-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.25);
  opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.drawer-overlay.open { opacity: 1; pointer-events: auto; }
.right-drawer {
  position: fixed; top: 0; right: 0; bottom: 0;
  width: var(--drawer-w); z-index: 201;
  background: var(--surface);
  box-shadow: -4px 0 40px rgba(0,0,0,0.18);
  transform: translateX(100%); transition: transform 0.3s cubic-bezier(.4,0,.2,1);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.right-drawer.open { transform: translateX(0); }

.drawer-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border-light);
  display: flex; align-items: flex-start; gap: 12px;
  background: var(--surface);
  flex-shrink: 0;
}
.drawer-header-info { flex: 1; }
.drawer-title { font-size: 15px; font-weight: 700; color: var(--text); }
.drawer-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.drawer-close {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  background: var(--surface2); border: 1px solid var(--border);
  font-size: 18px; cursor: pointer; color: var(--text-muted);
  transition: all 0.15s; flex-shrink: 0;
}
.drawer-close:hover { background: var(--alert-bg); color: var(--alert); }

.drawer-body { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 16px; }

.drawer-section-title {
  font-size: 10px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.8px;
  margin-bottom: 8px; padding-bottom: 6px;
  border-bottom: 1px solid var(--border-light);
}

.info-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.info-item { }
.info-key { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; }
.info-val { font-size: 13px; color: var(--text); margin-top: 2px; font-weight: 500; }
.info-val.mono { font-family: var(--mono); }
.info-val.price { color: var(--primary); font-weight: 700; font-family: var(--mono); }
.info-val.margin { color: var(--success); font-weight: 700; font-family: var(--mono); }

/* TIMELINE */
.timeline { display: flex; flex-direction: column; gap: 0; }
.timeline-step {
  display: flex; gap: 12px; align-items: flex-start;
  padding-bottom: 14px; position: relative;
}
.timeline-step:not(:last-child)::before {
  content: ''; position: absolute;
  left: 13px; top: 28px; bottom: 0;
  width: 2px; background: var(--border);
}
.step-dot {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 12px;
  border: 2px solid var(--border); background: var(--surface);
  z-index: 1;
}
.step-dot.active { border-color: var(--primary); background: var(--primary); color: white; }
.step-dot.done { border-color: var(--success); background: var(--success); color: white; }
.step-dot.pending { border-color: var(--warn); background: var(--warn-bg); color: var(--warn); }
.step-content { flex: 1; padding-top: 4px; }
.step-title { font-size: 12px; font-weight: 600; color: var(--text); }
.step-time { font-size: 10px; color: var(--text-muted); font-family: var(--mono); margin-top: 2px; }
.step-note { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

/* HISTORY TABLE */
.history-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.history-table th {
  padding: 5px 8px; font-size: 9px; background: var(--surface2);
  text-align: left; color: var(--text-muted); font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.4px;
}
.history-table td { padding: 6px 8px; border-bottom: 1px solid var(--border-light); color: var(--text); }
.history-table tr:hover td { background: var(--surface2); }

/* QUICK ACTIONS */
.quick-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.qa-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 14px; border-radius: var(--radius);
  font-size: 12px; font-weight: 600; cursor: pointer;
  border: 1.5px solid; transition: all 0.15s;
}
.qa-approve { border-color: var(--success); color: var(--success); background: var(--success-bg); }
.qa-approve:hover { background: var(--success); color: white; }
.qa-reject { border-color: var(--alert); color: var(--alert); background: var(--alert-bg); }
.qa-reject:hover { background: var(--alert); color: white; }
.qa-invoice { border-color: var(--primary); color: var(--primary); background: var(--info-bg); }
.qa-invoice:hover { background: var(--primary); color: white; }
.qa-slots { border-color: var(--warn); color: var(--warn); background: var(--warn-bg); }
.qa-slots:hover { background: var(--warn); color: white; }
.qa-done { border-color: var(--text-muted); color: var(--text-muted); background: var(--surface2); }
.qa-done:hover { background: var(--text-muted); color: white; }

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  padding: 12px 16px; border-radius: var(--radius);
  background: var(--text); color: white;
  font-size: 12px; font-weight: 500;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease;
  max-width: 280px; line-height: 1.4;
}
.toast.success { background: var(--success); }
.toast.warn { background: var(--warn); }
.toast.error { background: var(--alert); }
@keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }
.toast.out { animation: toastOut 0.3s ease forwards; }

/* ‚îÄ‚îÄ‚îÄ AUDIT LOG MODAL ‚îÄ‚îÄ‚îÄ */
.audit-modal {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.4);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.audit-modal.open { opacity: 1; pointer-events: auto; }
.audit-box {
  background: white; border-radius: var(--radius-lg);
  width: 540px; max-width: 95vw; max-height: 80vh;
  display: flex; flex-direction: column;
  box-shadow: var(--shadow-lg);
}
.audit-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border-light);
  display: flex; align-items: center; gap: 10px;
}
.audit-header h3 { font-size: 15px; font-weight: 700; flex: 1; }
.audit-close {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  background: var(--surface2); cursor: pointer; font-size: 18px;
  color: var(--text-muted); border: 1px solid var(--border);
}
.audit-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
.audit-entry {
  padding: 10px 0; border-bottom: 1px solid var(--border-light);
  font-size: 12px;
}
.audit-action { font-weight: 700; color: var(--primary); }
.audit-meta { color: var(--text-muted); font-family: var(--mono); font-size: 11px; margin-top: 2px; }

/* ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ */
.login-screen {
  position: fixed; inset: 0; z-index: 500;
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--accent) 100%);
  display: flex; align-items: center; justify-content: center;
}
.login-card {
  background: white; border-radius: var(--radius-lg);
  padding: 40px 36px; width: 360px; max-width: 95vw;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.login-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 28px; }
.login-logo-img {
  width: 60px; height: 40px; border-radius: 0;
  object-fit: contain;
  background: transparent;
  border: none;
  padding: 0;
}
.login-logo-text h2 { font-size: 18px; font-weight: 700; color: var(--text); }
.login-logo-text p { font-size: 11px; color: var(--text-muted); }
.login-field { margin-bottom: 16px; }
.login-field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
.login-field input {
  width: 100%; padding: 10px 14px; border: 1.5px solid var(--border);
  border-radius: var(--radius); font-size: 14px; color: var(--text);
  outline: none; transition: border-color 0.15s;
}
.login-field input:focus { border-color: var(--primary); }
.login-btn {
  width: 100%; padding: 12px; border-radius: var(--radius);
  background: var(--primary); color: white; font-size: 15px; font-weight: 700;
  border: none; cursor: pointer; margin-top: 8px; transition: background 0.15s;
}
.login-btn:hover { background: var(--primary-dark); }
.login-hint { font-size: 11px; color: var(--text-muted); margin-top: 12px; text-align: center; }
.login-error { color: var(--alert); font-size: 12px; margin-top: 8px; text-align: center; }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state {
  text-align: center; padding: 60px 20px;
  color: var(--text-muted);
}
.empty-state .emoji { font-size: 48px; margin-bottom: 12px; }
.empty-state h3 { font-size: 16px; font-weight: 700; margin-bottom: 6px; color: var(--text); }
.empty-state p { font-size: 13px; }

/* ‚îÄ‚îÄ‚îÄ LOADING SKELETON ‚îÄ‚îÄ‚îÄ */
.skeleton {
  background: linear-gradient(90deg, var(--surface2) 25%, var(--border-light) 50%, var(--surface2) 75%);
  background-size: 200% 100%; animation: shimmer 1.5s infinite;
  border-radius: 4px;
}
@keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media (max-width: 900px) {
  th:nth-child(4), td:nth-child(4) { display: none; }
  th:nth-child(5), td:nth-child(5) { display: none; }
  :root { --drawer-w: 100vw; }
}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <img class="login-logo-img" src="./cpac-logo.jpg" alt="CPAC logo">
      <div class="login-logo-text">
        <h2>Dealer Portal</h2>
        <p id="portalSubtitle">Activity Dashboard "‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢"</p>
      </div>
    </div>
    <div class="login-field">
      <label>Dealer Token / Username</label>
      <input type="text" id="loginUser" value="dealer01" placeholder="dealer01">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPass" value="1234" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="login-btn" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <p class="login-hint" id="loginHint">Demo: dealer01 / 1234</p>
    <p class="login-error" id="loginError"></p>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ -->
<div id="app" style="display:none;">

<!-- HEADER -->
<header class="app-header">
  <div class="header-logo">
    <img class="header-logo-img" src="./cpac-logo.jpg" alt="CPAC logo">
    <div>
      <div class="header-title" id="headerTitle">Dealer Daily Activity Dashboard</div>
      <div class="header-subtitle" id="headerCompany">‡∏ö.‡∏ô‡∏ß‡∏ä‡∏±‡∏¢ ‡πÅ‡∏°‡∏ó‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏• ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏Å.</div>
    </div>
  </div>
  <div class="header-spacer"></div>
  <div class="header-time">
    <div>Last updated</div>
    <strong id="lastUpdated">‚Äî</strong>
  </div>
  <div class="header-controls">
    <select id="intervalSelect" onchange="setInterval_()">
      <option value="0">Auto: Off</option>
      <option value="15">15 ‡∏ß‡∏¥</option>
      <option value="30" selected>30 ‡∏ß‡∏¥</option>
      <option value="60">1 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
      <option value="300">5 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
    </select>
    <button class="btn btn-ghost" id="changedToggle" onclick="toggleChanged()">üîÑ Changed Only</button>
    <button class="btn btn-primary" onclick="doRefresh()">‚ü≥ Refresh Now</button>
    <button class="btn btn-ghost" onclick="window.location.href='setting.html'" title="Settings">‚öô</button>
    <button class="btn btn-ghost" onclick="openAuditLog()" title="Audit Log">üìã</button>
    <button class="btn btn-ghost" onclick="doLogout()" title="Logout">‚èª</button>
  </div>
</header>

<!-- FILTER BAR -->
<div class="filter-bar">
  <div class="filter-group">
    <span class="filter-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
    <select class="filter-select" id="fDate" onchange="applyFilters()">
      <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
      <option value="yesterday">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</option>
      <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
    </select>
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
    <select class="filter-select" id="fTime" onchange="applyFilters()">
      <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</option>
      <option value="06-09">06:00-09:00</option>
      <option value="09-12">09:00-12:00</option>
      <option value="12-15">12:00-15:00</option>
      <option value="15-18">15:00-18:00</option>
      <option value="18-21">18:00-21:00</option>
      <option value="21-24">21:00-24:00</option>
      <option value="00-03">24:00-03:00</option>
      <option value="03-06">03:00-06:00</option>
    </select>
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span>
    <input class="filter-input" id="fProv" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..." style="width:130px" oninput="applyFilters()">
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">Severity</span>
    <span class="filter-chip sev-alert active" data-sev="ALERT" onclick="toggleChip(this,'sev')">üî¥ ALERT</span>
    <span class="filter-chip sev-warn active" data-sev="WARN" onclick="toggleChip(this,'sev')">üü° WARN</span>
    <span class="filter-chip sev-info active" data-sev="INFO" onclick="toggleChip(this,'sev')">üîµ INFO</span>
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>
    <select class="filter-select" id="fType" onchange="applyFilters()">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    </select>
  </div>
  <div class="filter-divider"></div>
  <div class="filter-group">
    <span class="filter-label" id="fSiteProjectLabel">‡πÑ‡∏ã‡∏ï‡πå/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
    <select class="filter-select" id="fSiteProject" style="min-width:260px" onchange="applyFilters()">
      <option value="">‡πÑ‡∏ã‡∏ï‡πå/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    </select>
  </div>
</div>

<!-- KPI STRIP -->
<div class="kpi-strip" id="kpiStrip"></div>

<!-- MAIN -->
<div class="main-content" id="mainContent">
  <div class="table-wrap">
    <div class="table-tabs">
      <button class="table-tab active" id="tabActivity" onclick="switchMainTab('activity')">Activity Time Log</button>
      <button class="table-tab" id="tabDailyPour" onclick="switchMainTab('daily-pour')">‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</button>
    </div>
    <div class="table-header-bar">
      <span class="table-title" id="tableTitle">Activity Time Log</span>
      <span class="table-count" id="tableCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      <div class="table-spacer"></div>
      <span class="new-badge-indicator" id="newBadge" style="display:none">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
    </div>
    <div class="table-panel active" id="activityPanel">
      <div style="overflow-x:auto;">
        <table id="actTable">
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
              <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th>‡πÑ‡∏ã‡∏ï‡πå/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
              <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="actBody"></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
    <div class="table-panel" id="dailyPourPanel">
      <div style="overflow-x:auto;">
        <table id="pourTable">
          <thead>
            <tr>
              <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô‡∏à‡∏≠‡∏á</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
              <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á (‡∏Ñ‡∏¥‡∏ß)</th>
              <th>‡∏¢‡∏≠‡∏î Confirm (‡∏Ñ‡∏¥‡∏ß)</th>
              <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏ó (‡∏Ñ‡∏¥‡∏ß)</th>
              <th>‡∏Ñ‡πâ‡∏≤‡∏á‡∏õ‡∏π‡∏ô</th>
              <th>‡∏õ‡∏±‡πä‡∏°</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó</th>
            </tr>
          </thead>
          <tbody id="pourBody"></tbody>
        </table>
      </div>
      <div class="pagination" id="paginationPour"></div>
    </div>
  </div>
</div>

</div><!-- #app -->

<!-- ‚îÄ‚îÄ‚îÄ RIGHT DRAWER ‚îÄ‚îÄ‚îÄ -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="right-drawer" id="rightDrawer">
  <div class="drawer-header">
    <div class="drawer-header-info">
      <div class="drawer-title" id="drawerTitle">‚Äî</div>
      <div class="drawer-subtitle" id="drawerSubtitle">‚Äî</div>
    </div>
    <div class="drawer-close" onclick="closeDrawer()">‚úï</div>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ AUDIT LOG MODAL ‚îÄ‚îÄ‚îÄ -->
<div class="audit-modal" id="auditModal">
  <div class="audit-box">
    <div class="audit-header">
      <h3>üìã Audit Log</h3>
      <div class="audit-close" onclick="closeAuditLog()">‚úï</div>
    </div>
    <div class="audit-body" id="auditBody"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOCK DATA & STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentUser = null;
let autoRefreshTimer = null;
let showChangedOnly = false;
let selectedKpi = null;
let currentPage = 1;
let currentPourPage = 1;
let PAGE_SIZE = 25;
let activeMainTab = 'activity';
let allEvents = [];
let filteredEvents = [];
let filteredDailyPourRows = [];
let dailyJobsFromExcel = [];
let hasDailyJobsExcel = false;
let newEventIds = new Set();
let auditLog = [];
let selectedEventId = null;

const EVENT_TYPES = {
  SITE_PENDING:       { label: '‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡∏ï‡πå', icon: 'üèóÔ∏è' },
  QUOTE_SENT:         { label: '‡∏™‡πà‡∏á Quotation', icon: 'üìÑ' },
  ADD_PRODUCT:        { label: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', icon: '‚ûï' },
  BOOKING_REQUEST:    { label: '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß', icon: 'üìÖ' },
  BOOKING_CONFIRMED:  { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó', icon: '‚úÖ' },
  INVOICE_CREATED:    { label: '‡∏≠‡∏≠‡∏Å Invoice', icon: 'üßæ' },
  PAYMENT_PENDING:    { label: '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞', icon: 'üí≥' },
  PAYMENT_CONFIRMED:  { label: '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', icon: '‚úîÔ∏è' },
  DISPATCH_LIVE:      { label: 'Dispatch Live', icon: 'üöõ' },
  CUSTOMER_ACTION:    { label: 'Action ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', icon: 'üì±' },
  POUR_REMINDER:      { label: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó', icon: '‚è∞' },
};

const STATES = {
  PENDING_APPROVAL: { label: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', cls: 'state-pending' },
  APPROVED:         { label: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', cls: 'state-approved' },
  REJECTED:         { label: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', cls: 'state-rejected' },
  NEW:              { label: '‡πÉ‡∏´‡∏°‡πà', cls: 'state-new' },
  PROCESSING:       { label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô', cls: 'state-processing' },
  CONFIRMED:        { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', cls: 'state-confirmed' },
  INVOICED:         { label: '‡∏≠‡∏≠‡∏Å Invoice', cls: 'state-invoiced' },
  PAID:             { label: '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', cls: 'state-paid' },
  DISPATCHED:       { label: 'Dispatch', cls: 'state-dispatched' },
  DONE:             { label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', cls: 'state-done' },
};

let PROVINCES = ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û','‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ','‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ','‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£','‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ','‡∏£‡∏∞‡∏¢‡∏≠‡∏á','‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤','‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô','‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ','‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà','‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï','‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ','‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤','‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ','‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ','‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°','‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ','‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'];
let CUSTOMER_NAMES = ['‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡πÑ‡∏• ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏µ ‡∏à‡∏≥‡∏Å‡∏±‡∏î','‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏µ‡∏ä‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏°‡∏≤','‡∏´‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô ‡∏ä‡∏ß‡∏ô‡∏ä‡∏±‡∏¢','‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ô‡∏∞ ‡∏≠‡∏î‡∏ó‡∏ô','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡∏à‡∏≥‡∏Å‡∏±‡∏î','‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∏‡∏î‡∏≤ ‡∏î‡∏ß‡∏á‡∏î‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ‡∏à‡∏≥‡∏Å‡∏±‡∏î','‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏£‡∏ó‡∏±‡∏¢ ‡∏á‡∏≤‡∏°‡∏î‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏ô‡∏Å‡∏£ ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢','‡∏´‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô ‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ','‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏°‡∏• ‡∏™‡∏∏‡∏Ç‡∏™‡∏°','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î'];
let PRODUCTS = ['‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 240 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 280 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 300 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 320 ksc','‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 350 ksc'];
let PLANTS = ['‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏ô‡∏≤','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 2','‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ'];

const DEALER_COMPANY_NAME = '‡∏ö.‡∏ô‡∏ß‡∏ä‡∏±‡∏¢ ‡πÅ‡∏°‡∏ó‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏• ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏Å.';
const DEALER_PORTAL_SUBTITLE = 'Activity Dashboard "‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢"';
const POUR_TRACKING_BASE_URL = 'https://bluenet.scg.com/sda/#/dp-list?orderNo=';
const DEFAULT_TRACKING_ORDER_NO = '9dbc19d1459343ec8cb70b235a064dbf';

const DASHBOARD_SETTINGS_KEY = 'dealerDashboardSettingsV1';
const DEFAULT_DASHBOARD_SETTINGS = {
  appTitle: 'Dealer Daily Activity Dashboard',
  appSubtitle: DEALER_PORTAL_SUBTITLE,
  loginUsername: 'dealer01',
  loginPassword: '1234',
  pageSize: 25,
  initialEventCount: 60,
  refreshNewEventMin: 0,
  refreshNewEventMax: 3,
  defaultAutoRefreshSeconds: 30,
  autoRefreshOptions: [0, 15, 30, 60, 300],
  showChangedOnlyDefault: false,
  enabledEventTypes: Object.keys(EVENT_TYPES),
  provinces: [...PROVINCES],
  customers: [...CUSTOMER_NAMES],
  products: [...PRODUCTS],
  plants: [...PLANTS],
};

let dashboardSettings = { ...DEFAULT_DASHBOARD_SETTINGS };

function toInt(value, fallback) {
  const n = parseInt(value, 10);
  return Number.isFinite(n) ? n : fallback;
}

function clampInt(value, fallback, min, max) {
  const n = toInt(value, fallback);
  return Math.min(Math.max(n, min), max);
}

function sanitizeStringArray(value, fallback) {
  if (!Array.isArray(value)) return [...fallback];
  const cleaned = value
    .map(v => String(v || '').trim())
    .filter(Boolean);
  return cleaned.length ? cleaned : [...fallback];
}

function sanitizeNumberArray(value, fallback) {
  if (!Array.isArray(value)) return [...fallback];
  const unique = [];
  value.forEach(v => {
    const n = toInt(v, NaN);
    if (Number.isFinite(n) && n >= 0 && !unique.includes(n)) {
      unique.push(n);
    }
  });
  unique.sort((a, b) => a - b);
  return unique.length ? unique : [...fallback];
}

function normalizeDashboardSettings(raw = {}) {
  const merged = { ...DEFAULT_DASHBOARD_SETTINGS, ...(raw || {}) };
  const eventKeys = Object.keys(EVENT_TYPES);
  const legacyCombinedTitle = 'Dealer Daily Activity Dashboard ‚Äî ‡∏ö.‡∏ô‡∏ß‡∏ä‡∏±‡∏¢ ‡πÅ‡∏°‡∏ó‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏• ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏Å.';
  const legacySubtitle = '‡∏ô‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÉ‡∏à ‚Äî Activity Dashboard';

  const settings = {
    appTitle: String(merged.appTitle || DEFAULT_DASHBOARD_SETTINGS.appTitle).trim() || DEFAULT_DASHBOARD_SETTINGS.appTitle,
    appSubtitle: String(merged.appSubtitle || DEFAULT_DASHBOARD_SETTINGS.appSubtitle).trim() || DEFAULT_DASHBOARD_SETTINGS.appSubtitle,
    loginUsername: String(merged.loginUsername || DEFAULT_DASHBOARD_SETTINGS.loginUsername).trim() || DEFAULT_DASHBOARD_SETTINGS.loginUsername,
    loginPassword: String(merged.loginPassword || DEFAULT_DASHBOARD_SETTINGS.loginPassword),
    pageSize: clampInt(merged.pageSize, DEFAULT_DASHBOARD_SETTINGS.pageSize, 5, 200),
    initialEventCount: clampInt(merged.initialEventCount, DEFAULT_DASHBOARD_SETTINGS.initialEventCount, 10, 500),
    refreshNewEventMin: clampInt(merged.refreshNewEventMin, DEFAULT_DASHBOARD_SETTINGS.refreshNewEventMin, 0, 50),
    refreshNewEventMax: clampInt(merged.refreshNewEventMax, DEFAULT_DASHBOARD_SETTINGS.refreshNewEventMax, 0, 50),
    defaultAutoRefreshSeconds: clampInt(merged.defaultAutoRefreshSeconds, DEFAULT_DASHBOARD_SETTINGS.defaultAutoRefreshSeconds, 0, 3600),
    autoRefreshOptions: sanitizeNumberArray(merged.autoRefreshOptions, DEFAULT_DASHBOARD_SETTINGS.autoRefreshOptions),
    showChangedOnlyDefault: Boolean(merged.showChangedOnlyDefault),
    enabledEventTypes: sanitizeStringArray(merged.enabledEventTypes, DEFAULT_DASHBOARD_SETTINGS.enabledEventTypes)
      .filter(key => eventKeys.includes(key)),
    provinces: sanitizeStringArray(merged.provinces, DEFAULT_DASHBOARD_SETTINGS.provinces),
    customers: sanitizeStringArray(merged.customers, DEFAULT_DASHBOARD_SETTINGS.customers),
    products: sanitizeStringArray(merged.products, DEFAULT_DASHBOARD_SETTINGS.products),
    plants: sanitizeStringArray(merged.plants, DEFAULT_DASHBOARD_SETTINGS.plants),
  };

  if (settings.appTitle === legacyCombinedTitle) {
    settings.appTitle = DEFAULT_DASHBOARD_SETTINGS.appTitle;
  }
  if (settings.appSubtitle === legacySubtitle || settings.appSubtitle === DEALER_COMPANY_NAME) {
    settings.appSubtitle = DEFAULT_DASHBOARD_SETTINGS.appSubtitle;
  }

  if (!settings.enabledEventTypes.length) {
    settings.enabledEventTypes = [...DEFAULT_DASHBOARD_SETTINGS.enabledEventTypes];
  }
  if (settings.refreshNewEventMax < settings.refreshNewEventMin) {
    settings.refreshNewEventMax = settings.refreshNewEventMin;
  }
  if (!settings.autoRefreshOptions.includes(settings.defaultAutoRefreshSeconds)) {
    settings.autoRefreshOptions.push(settings.defaultAutoRefreshSeconds);
    settings.autoRefreshOptions.sort((a, b) => a - b);
  }

  return settings;
}

function getEnabledEventTypeKeys() {
  const keys = dashboardSettings?.enabledEventTypes || [];
  return keys.length ? keys : Object.keys(EVENT_TYPES);
}

function formatIntervalLabel(seconds) {
  if (seconds === 0) return 'Auto: Off';
  if (seconds < 60) return `${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
  if (seconds % 60 === 0) return `${seconds / 60} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  return `${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
}

function renderIntervalOptions() {
  const select = document.getElementById('intervalSelect');
  if (!select) return;
  select.innerHTML = dashboardSettings.autoRefreshOptions.map(sec => (
    `<option value="${sec}">${formatIntervalLabel(sec)}</option>`
  )).join('');
}

function renderEventTypeOptions() {
  const select = document.getElementById('fType');
  if (!select) return;
  const current = select.value;
  const options = getEnabledEventTypeKeys().map(key => {
    const info = EVENT_TYPES[key];
    const label = info ? info.label : key;
    return `<option value="${key}">${label}</option>`;
  });
  select.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${options.join('')}`;
  if ([...select.options].some(opt => opt.value === current)) {
    select.value = current;
  }
}

function applyDashboardSettingsToUI() {
  PAGE_SIZE = dashboardSettings.pageSize;
  PROVINCES = [...dashboardSettings.provinces];
  CUSTOMER_NAMES = [...dashboardSettings.customers];
  PRODUCTS = [...dashboardSettings.products];
  PLANTS = [...dashboardSettings.plants];
  showChangedOnly = dashboardSettings.showChangedOnlyDefault;

  const titleEl = document.getElementById('headerTitle');
  const companyEl = document.getElementById('headerCompany');
  const subtitleEl = document.getElementById('portalSubtitle');
  if (titleEl) titleEl.textContent = dashboardSettings.appTitle;
  if (companyEl) companyEl.textContent = DEALER_COMPANY_NAME;
  if (subtitleEl) subtitleEl.textContent = dashboardSettings.appSubtitle;
  document.title = dashboardSettings.appTitle;

  const userEl = document.getElementById('loginUser');
  const passEl = document.getElementById('loginPass');
  const hintEl = document.getElementById('loginHint');
  if (userEl) userEl.value = dashboardSettings.loginUsername;
  if (passEl) passEl.value = dashboardSettings.loginPassword;
  if (hintEl) hintEl.textContent = `Demo: ${dashboardSettings.loginUsername} / ${dashboardSettings.loginPassword}`;

  renderIntervalOptions();
  const intervalSelect = document.getElementById('intervalSelect');
  if (intervalSelect) intervalSelect.value = String(dashboardSettings.defaultAutoRefreshSeconds);

  renderEventTypeOptions();
  const changedBtn = document.getElementById('changedToggle');
  if (changedBtn) changedBtn.classList.toggle('active', showChangedOnly);
}

function loadDashboardSettings() {
  let raw = null;
  try {
    raw = JSON.parse(localStorage.getItem(DASHBOARD_SETTINGS_KEY) || 'null');
  } catch (err) {
    raw = null;
  }
  dashboardSettings = normalizeDashboardSettings(raw || {});
  applyDashboardSettingsToUI();
}

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function randFrom(arr) { return arr[randInt(0, arr.length - 1)]; }
function randPhone() { return `08${randInt(1,9)}${randInt(1000000,9999999)}`; }
function fmtTime(date) { return date.toTimeString().slice(0,5); }
function fmtDateTime(date) { return date.toLocaleString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function formatMoney(n) { return n.toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó'; }

let idCounter = 1;
function genEvent(hoursAgo = 0, isNew = false) {
  const now = new Date();
  const ts = new Date(now - hoursAgo * 3600000 - randInt(0, 3600000));
  const types = getEnabledEventTypeKeys();
  const type = randFrom(types);
  const prov = randFrom(PROVINCES);
  const siteNum = randInt(1000, 9999);
  const siteCode = `SC-${prov.slice(0,2)}-${siteNum}`;
  const custName = randFrom(CUSTOMER_NAMES);
  const custPhone = randPhone();
  const qtyM3 = randInt(2, 30);
  const product = randFrom(PRODUCTS);
  const plant = randFrom(PLANTS);
  const quoteNo = `QT-${new Date().getFullYear()}-${randInt(10000,99999)}`;
  const bookingId = `BK-${randInt(100000,999999)}`;
  const invoiceNo = `INV-${randInt(100000,999999)}`;
  const custPrice = randInt(2500, 3500) * qtyM3;
  const dealerPrice = Math.round(custPrice * 0.88);
  const margin = custPrice - dealerPrice;

  const statesByType = {
    SITE_PENDING: 'PENDING_APPROVAL',
    QUOTE_SENT: 'NEW',
    ADD_PRODUCT: 'PROCESSING',
    BOOKING_REQUEST: 'PENDING_APPROVAL',
    BOOKING_CONFIRMED: 'CONFIRMED',
    INVOICE_CREATED: 'INVOICED',
    PAYMENT_PENDING: 'PENDING_APPROVAL',
    PAYMENT_CONFIRMED: 'PAID',
    DISPATCH_LIVE: 'DISPATCHED',
    CUSTOMER_ACTION: 'NEW',
    POUR_REMINDER: 'PROCESSING',
  };

  const sevByType = {
    SITE_PENDING: 'INFO',
    QUOTE_SENT: 'INFO',
    ADD_PRODUCT: 'WARN',
    BOOKING_REQUEST: 'WARN',
    BOOKING_CONFIRMED: 'INFO',
    INVOICE_CREATED: 'INFO',
    PAYMENT_PENDING: 'ALERT',
    PAYMENT_CONFIRMED: 'INFO',
    DISPATCH_LIVE: 'ALERT',
    CUSTOMER_ACTION: 'WARN',
    POUR_REMINDER: 'ALERT',
  };

  const keyDetailByType = {
    SITE_PENDING: `‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà: ${prov} ‚Äî ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å ${randInt(1,500)} ‡∏¢‡∏π‡∏ô‡∏¥‡∏ï`,
    QUOTE_SENT: `${product} √ó ${qtyM3} ‡∏Ñ‡∏¥‡∏ß ‚Äî ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${custPrice.toLocaleString()} / Dealer ${dealerPrice.toLocaleString()}`,
    ADD_PRODUCT: `‡πÄ‡∏û‡∏¥‡πà‡∏° ${product} √ó ${randInt(1,5)} ‡∏Ñ‡∏¥‡∏ß ‡πÄ‡∏Ç‡πâ‡∏≤ ${quoteNo}`,
    BOOKING_REQUEST: `‡∏à‡∏≠‡∏á ${product} √ó ${qtyM3} ‡∏Ñ‡∏¥‡∏ß ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${ts.toLocaleDateString('th-TH')}`,
    BOOKING_CONFIRMED: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó ${qtyM3} ‡∏Ñ‡∏¥‡∏ß ‚Äî ${plant}`,
    INVOICE_CREATED: `${invoiceNo} ‡∏£‡∏ß‡∏° ${formatMoney(custPrice)}`,
    PAYMENT_PENDING: `‡∏£‡∏≠‡∏î‡∏µ‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${formatMoney(custPrice)}`,
    PAYMENT_CONFIRMED: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${formatMoney(custPrice)} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`,
    DISPATCH_LIVE: `üöõ ‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${randInt(1,5)} ‡∏Ñ‡∏±‡∏ô ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° LIVE`,
    CUSTOMER_ACTION: `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î "${randFrom(['‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏à‡∏ô‡∏ó.','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏ó','‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤'])}"`,
    POUR_REMINDER: `‡πÄ‡∏ó‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡πÉ‡∏ô ${randInt(1,120)} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Äî T-2h reminder`,
  };

  return {
    id: `EVT-${String(idCounter++).padStart(5,'0')}`,
    ts: ts.toISOString(),
    eventType: type,
    severity: sevByType[type],
    isNew: isNew,
    customer: { lineName: custName, phone: custPhone },
    site: {
      siteCode,
      projectName: `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${prov} ‡πÄ‡∏£‡∏™‡∏ã‡∏¥‡πÄ‡∏î‡∏ô‡∏ã‡πå ${randInt(1,10)}`,
      province: prov,
      mapUrl: `https://maps.google.com?q=${prov}`
    },
    quote: { quoteNo, itemsSummary: `${product} √ó ${qtyM3}`, customerPrice: custPrice, dealerPrice, margin },
    booking: { bookingId, pourDateTime: new Date(ts.getTime() + 86400000 * randInt(1,7)).toISOString(), product, qtyM3, truckType: `‡∏£‡∏ñ ${randInt(6,10)} ‡∏Ñ‡∏¥‡∏ß`, plant },
    invoice: { invoiceNo, total: custPrice, status: '‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' },
    status: { currentState: statesByType[type], previousState: 'NEW' },
    keyDetail: keyDetailByType[type],
    isDone: false,
    doneBy: null, doneAt: null,
  };
}

function generateMockData() {
  const events = [];
  const totalEvents = dashboardSettings?.initialEventCount || 60;
  for (let i = 0; i < totalEvents; i++) {
    events.push(genEvent(i * 0.13));
  }
  // Sort newest first
  events.sort((a,b) => new Date(b.ts) - new Date(a.ts));
  return events;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function doLogin() {
  const user = document.getElementById('loginUser').value;
  const pass = document.getElementById('loginPass').value;
  if (user === dashboardSettings.loginUsername && pass === dashboardSettings.loginPassword) {
    currentUser = { name: user, role: 'Dealer', token: 'mock-bearer-abc123' };
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initApp();
  } else {
    document.getElementById('loginError').textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
  }
}
function doLogout() {
  currentUser = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  clearInterval(autoRefreshTimer);
}
document.addEventListener('keydown', e => { if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') doLogin(); });

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initApp() {
  updateHeaderDate();
  allEvents = generateMockData();
  loadDailyJobsFromExcel().finally(() => {
    applyFilters();
    renderKpis();
    setInterval_();
  });
}

function updateHeaderDate() {
  const now = new Date();
  document.getElementById('lastUpdated').textContent = fmtDateTime(now);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REFRESH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function doRefresh() {
  const prevIds = new Set(allEvents.map(e => e.id));
  const minNew = dashboardSettings?.refreshNewEventMin ?? 0;
  const maxNew = dashboardSettings?.refreshNewEventMax ?? 3;
  const newCount = randInt(minNew, maxNew);
  const newEvts = [];
  for (let i = 0; i < newCount; i++) {
    const e = genEvent(0, true);
    newEvts.push(e);
  }
  // Update some existing events
  allEvents.forEach(e => {
    if (Math.random() < 0.05) {
      e.isChanged = true;
    }
  });
  allEvents = [...newEvts, ...allEvents];
  newEventIds = new Set(newEvts.map(e => e.id));
  applyFilters();
  renderKpis();
  updateHeaderDate();
  if (newCount > 0) {
    showToast(`üîî ${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤`, 'success');
  } else {
    showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
  }
  const badge = document.getElementById('newBadge');
  if (activeMainTab === 'activity' && newCount > 0) {
    badge.style.display = 'inline-flex';
    badge.textContent = `${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà`;
  } else {
    badge.style.display = 'none';
  }
}

function setInterval_() {
  clearInterval(autoRefreshTimer);
  const val = parseInt(document.getElementById('intervalSelect').value);
  if (val > 0) {
    autoRefreshTimer = setInterval(doRefresh, val * 1000);
  }
}

function toggleChanged() {
  showChangedOnly = !showChangedOnly;
  const btn = document.getElementById('changedToggle');
  btn.classList.toggle('active', showChangedOnly);
  applyFilters();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILTERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getActiveSevs() {
  return [...document.querySelectorAll('.filter-chip.active[data-sev]')].map(c => c.dataset.sev);
}
function toggleChip(el, group) {
  el.classList.toggle('active');
  applyFilters();
}

function toNum(value) {
  if (typeof value === 'number') return Number.isFinite(value) ? value : 0;
  const cleaned = String(value || '').replace(/,/g, '').trim();
  if (!cleaned || cleaned === '-') return 0;
  const n = Number.parseFloat(cleaned);
  return Number.isFinite(n) ? n : 0;
}

function parseSheetDate(value) {
  const raw = String(value || '').trim();
  if (!raw) return null;
  const m = raw.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const day = Number.parseInt(m[1], 10);
    const month = Number.parseInt(m[2], 10) - 1;
    let year = Number.parseInt(m[3], 10);
    if (year < 100) year += 2000;
    const d = new Date(year, month, day);
    if (!Number.isNaN(d.getTime())) return d;
  }
  const fallback = new Date(raw);
  return Number.isNaN(fallback.getTime()) ? null : fallback;
}

function extractProductCode(value) {
  const text = String(value || '').trim();
  if (!text) return '-';
  const head = text.split(' - ')[0].trim();
  return head || text;
}

function extractOrderNoFromText(value) {
  const text = String(value || '').trim();
  if (!text) return '';
  const paramMatch = text.match(/[?&]orderNo=([a-zA-Z0-9_-]+)/i);
  if (paramMatch) return paramMatch[1];
  const hashMatch = text.match(/\b[a-f0-9]{32}\b/i);
  if (hashMatch) return hashMatch[0];
  return '';
}

function buildTrackingUrl(orderNo) {
  const key = String(orderNo || '').trim();
  if (!key) return '';
  return `${POUR_TRACKING_BASE_URL}${encodeURIComponent(key)}`;
}

function deriveTrackingOrderNo(row = [], bookingId = '') {
  for (let i = 0; i < row.length; i++) {
    const found = extractOrderNoFromText(row[i]);
    if (found) return found;
  }
  const fallback = String(bookingId || '').trim();
  if (/^[a-f0-9]{32}$/i.test(fallback)) return fallback;
  return DEFAULT_TRACKING_ORDER_NO;
}

function mapDailyStatusClass(poStatus, bookingStatus) {
  const po = String(poStatus || '').toLowerCase();
  const booking = String(bookingStatus || '').toLowerCase();
  const all = `${po} ${booking}`;
  if (all.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || all.includes('cancel')) return 'state-rejected';
  if (all.includes('‡πÄ‡∏ó‡πÄ‡∏™‡∏£‡πá‡∏à') || all.includes('done')) return 'state-done';
  if (all.includes('‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô') || all.includes('pending')) return 'state-pending';
  if (all.includes('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß') || all.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) return 'state-approved';
  return 'state-new';
}

function mapDailyStatusLabel(poStatus, bookingStatus) {
  const po = String(poStatus || '').trim();
  if (po) return po;
  const booking = String(bookingStatus || '').trim();
  return booking || '-';
}

function normalizeDailyJobRow(row = []) {
  const pourDate = parseSheetDate(row[0]);
  const startTime = String(row[1] || '').trim();
  const jobNo = String(row[2] || '').trim();
  const poStatus = String(row[3] || '').trim();
  const agency = String(row[4] || '').trim();
  const contractor = String(row[5] || '').trim();
  const productCode = extractProductCode(row[6]);
  const bookedQty = toNum(row[7]);
  const confirmedQty = toNum(row[8]);
  const pouredQty = toNum(row[9]);
  const pendingQty = toNum(row[10]);
  const pumpRaw = String(row[11] || '').trim();
  const bookingStatus = String(row[16] || '').trim();
  const sourceEventId = null;
  const trackingOrderNo = deriveTrackingOrderNo(row, jobNo);
  const trackingUrl = buildTrackingUrl(trackingOrderNo);

  return {
    bookingId: jobNo || '-',
    statusLabel: mapDailyStatusLabel(poStatus, bookingStatus),
    statusCls: mapDailyStatusClass(poStatus, bookingStatus),
    agency: agency || '-',
    contractor: contractor || '-',
    productCode,
    bookedQty,
    confirmedQty,
    pouredQty,
    pendingQty,
    pump: pumpRaw || '-',
    hasPump: Boolean(pumpRaw && pumpRaw !== '-' && pumpRaw !== '0' && pumpRaw !== '0.0'),
    pourDate: pourDate ? pourDate.toISOString() : '',
    startTime,
    sourceEventId,
    trackingOrderNo,
    trackingUrl,
    raw: row,
  };
}

async function loadDailyJobsFromExcel() {
  hasDailyJobsExcel = false;
  dailyJobsFromExcel = [];
  if (!window.XLSX) return;

  try {
    const res = await fetch('./Daily job.xlsx', { cache: 'no-store' });
    if (!res.ok) return;
    const buffer = await res.arrayBuffer();
    const wb = XLSX.read(buffer, { type: 'array' });
    const firstSheet = wb.SheetNames?.[0];
    if (!firstSheet) return;

    const ws = wb.Sheets[firstSheet];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' });
    if (!Array.isArray(rows) || rows.length < 3) return;

    const dataRows = rows
      .slice(2)
      .map(normalizeDailyJobRow)
      .filter(r => r.bookingId !== '-' || r.agency !== '-' || r.contractor !== '-');

    if (!dataRows.length) return;
    dailyJobsFromExcel = dataRows;
    hasDailyJobsExcel = true;
  } catch (err) {
    hasDailyJobsExcel = false;
    dailyJobsFromExcel = [];
  }
}

function switchMainTab(tab) {
  activeMainTab = (tab === 'daily-pour') ? 'daily-pour' : 'activity';

  const activityTab = document.getElementById('tabActivity');
  const dailyTab = document.getElementById('tabDailyPour');
  const activityPanel = document.getElementById('activityPanel');
  const dailyPanel = document.getElementById('dailyPourPanel');

  if (activityTab) activityTab.classList.toggle('active', activeMainTab === 'activity');
  if (dailyTab) dailyTab.classList.toggle('active', activeMainTab === 'daily-pour');
  if (activityPanel) activityPanel.classList.toggle('active', activeMainTab === 'activity');
  if (dailyPanel) dailyPanel.classList.toggle('active', activeMainTab === 'daily-pour');

  applyFilters();
}

function isSameCalendarDate(a, b) {
  return a.getFullYear() === b.getFullYear()
    && a.getMonth() === b.getMonth()
    && a.getDate() === b.getDate();
}

function matchesDateFilter(ts, dateFilter, now = new Date()) {
  const eventDate = new Date(ts);
  if (Number.isNaN(eventDate.getTime())) return false;
  if (dateFilter === 'today') return isSameCalendarDate(eventDate, now);
  if (dateFilter === 'yesterday') {
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    return isSameCalendarDate(eventDate, yesterday);
  }
  return true;
}

function matchesTimeRange(ts, rangeKey) {
  if (!rangeKey || rangeKey === 'all') return true;
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return false;
  const minuteOfDay = d.getHours() * 60 + d.getMinutes();
  const ranges = {
    '06-09': [6 * 60, 9 * 60],
    '09-12': [9 * 60, 12 * 60],
    '12-15': [12 * 60, 15 * 60],
    '15-18': [15 * 60, 18 * 60],
    '18-21': [18 * 60, 21 * 60],
    '21-24': [21 * 60, 24 * 60],
    '00-03': [0, 3 * 60],
    '03-06': [3 * 60, 6 * 60],
  };
  const range = ranges[rangeKey];
  if (!range) return true;
  const [startMin, endMin] = range;
  if (endMin > startMin) return minuteOfDay >= startMin && minuteOfDay < endMin;
  return minuteOfDay >= startMin || minuteOfDay < endMin;
}

function renderSiteProjectOptions() {
  const select = document.getElementById('fSiteProject');
  const label = document.getElementById('fSiteProjectLabel');
  const dateFilter = document.getElementById('fDate')?.value || 'today';
  if (!select) return;

  const current = select.value;
  const now = new Date();
  const isDailyTab = activeMainTab === 'daily-pour';
  let options = [];

  if (isDailyTab) {
    if (label) label.textContent = '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô';
    const units = (hasDailyJobsExcel ? dailyJobsFromExcel : [])
      .filter(r => matchesDateFilter(r.pourDate, dateFilter, now))
      .map(r => String(r.agency || '').trim())
      .filter(Boolean);
    options = [...new Set(units)]
      .sort((a, b) => a.localeCompare(b, 'th'))
      .map(v => ({ value: v, label: v }));
  } else {
    if (label) label.textContent = '‡πÑ‡∏ã‡∏ï‡πå/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
    const sites = allEvents
      .filter(e => matchesDateFilter(e.ts, dateFilter, now))
      .map(e => ({
        code: String(e.site?.siteCode || '').trim(),
        project: String(e.site?.projectName || '').trim(),
      }))
      .filter(s => s.code || s.project);
    const unique = new Map();
    sites.forEach(s => {
      const key = s.code || s.project;
      if (!unique.has(key)) {
        const siteLabel = s.code && s.project ? `${s.code} - ${s.project}` : (s.code || s.project);
        unique.set(key, { value: key, label: siteLabel });
      }
    });
    options = [...unique.values()].sort((a, b) => a.label.localeCompare(b.label, 'th'));
  }

  select.innerHTML = '';
  const allOption = document.createElement('option');
  allOption.value = '';
  allOption.textContent = isDailyTab ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡πÑ‡∏ã‡∏ï‡πå/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
  select.appendChild(allOption);

  options.forEach(item => {
    const option = document.createElement('option');
    option.value = item.value;
    option.textContent = item.label;
    select.appendChild(option);
  });

  if (current && options.some(opt => opt.value === current)) {
    select.value = current;
  } else {
    select.value = '';
  }
}

function getStateInfoByEvent(eventItem) {
  const stateKey = eventItem?.status?.currentState || 'NEW';
  return STATES[stateKey] || { label: stateKey, cls: 'state-new' };
}

function toProductCode(product = '', eventId = '') {
  const p = String(product || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 5) || 'MIX';
  const suffix = String(eventId || '').replace(/\D/g, '').slice(-4).padStart(4, '0');
  return `${p}${suffix}B00`;
}

function calcDailyPourRows(events, options = {}) {
  const {
    fDate = 'today',
    fSiteProject = '',
    fProv = '',
    now = new Date(),
  } = options;

  if (hasDailyJobsExcel) {
    return dailyJobsFromExcel
      .filter(r => matchesDateFilter(r.pourDate, fDate, now))
      .filter(r => !fSiteProject || r.agency === fSiteProject)
      .filter(r => {
        if (!fProv) return true;
        const hay = `${r.agency} ${r.contractor}`.toLowerCase();
        return hay.includes(fProv);
      })
      .sort((a, b) => {
        const ad = new Date(a.pourDate);
        const bd = new Date(b.pourDate);
        const timeDiff = bd - ad;
        if (timeDiff !== 0) return timeDiff;
        return String(a.startTime || '').localeCompare(String(b.startTime || ''));
      });
  }

  const byBooking = new Map();
  const sorted = [...events].sort((a, b) => new Date(b.ts) - new Date(a.ts));
  const confirmTypes = new Set(['BOOKING_CONFIRMED', 'DISPATCH_LIVE', 'POUR_REMINDER', 'PAYMENT_PENDING', 'PAYMENT_CONFIRMED', 'INVOICE_CREATED']);

  sorted.forEach(e => {
    const bookingId = e.booking?.bookingId;
    if (!bookingId || byBooking.has(bookingId)) return;

    const qty = Number(e.booking?.qtyM3 || 0);
    const confirmedQty = confirmTypes.has(e.eventType) ? qty : 0;
    const baseQty = confirmedQty || qty;
    const pourProgress = e.isDone ? 1 : e.eventType === 'DISPATCH_LIVE' ? 0.7 : e.eventType === 'POUR_REMINDER' ? 0.45 : e.eventType === 'BOOKING_CONFIRMED' ? 0.25 : 0;
    const pouredQty = Math.round(baseQty * pourProgress * 100) / 100;
    const pendingQty = Math.max(baseQty - pouredQty, 0);
    const stateInfo = getStateInfoByEvent(e);

    byBooking.set(bookingId, {
      bookingId,
      statusLabel: e.isDone ? 'Done' : stateInfo.label,
      statusCls: stateInfo.cls,
      agency: e.booking?.plant || '-',
      contractor: e.customer?.lineName || '-',
      productCode: toProductCode(e.booking?.product, e.id),
      bookedQty: qty,
      confirmedQty,
      pouredQty,
      pendingQty,
      pump: qty >= 10 ? '‡πÉ‡∏ä‡πâ' : '-',
      hasPump: qty >= 10,
      pourDate: e.booking?.pourDateTime || e.ts,
      sourceEventId: e.id,
      trackingOrderNo: bookingId,
      trackingUrl: buildTrackingUrl(bookingId),
    });
  });

  return [...byBooking.values()]
    .filter(r => !fSiteProject || r.agency === fSiteProject)
    .sort((a, b) => new Date(a.pourDate) - new Date(b.pourDate));
}

function applyFilters() {
  const fDate = document.getElementById('fDate').value;
  renderSiteProjectOptions();
  const fSiteProject = document.getElementById('fSiteProject').value;
  const fProv = document.getElementById('fProv').value.toLowerCase().trim();
  const fType = document.getElementById('fType').value;
  const fTime = document.getElementById('fTime').value;
  const activeSevs = getActiveSevs();
  const now = new Date();

  filteredEvents = allEvents.filter(e => {
    if (!matchesDateFilter(e.ts, fDate, now)) return false;
    if (showChangedOnly && !e.isNew && !e.isChanged) return false;
    if (!activeSevs.includes(e.severity)) return false;
    if (fType && e.eventType !== fType) return false;
    if (activeMainTab === 'activity' && fSiteProject && e.site?.siteCode !== fSiteProject && e.site?.projectName !== fSiteProject) return false;
    if (fProv && !e.site.province.includes(fProv) && !e.site.province.toLowerCase().includes(fProv)) return false;
    if (!matchesTimeRange(e.ts, fTime)) return false;
    return true;
  });

  filteredDailyPourRows = calcDailyPourRows(filteredEvents, {
    fDate,
    fSiteProject,
    fProv,
    now,
  });
  currentPage = 1;
  currentPourPage = 1;
  renderTable();
  renderPagination();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KPI RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderKpis() {
  const today = new Date().toDateString();
  const kpis = [
    { label: '‡∏Ç‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà', type: 'alert', filter: 'SITE_PENDING', val: allEvents.filter(e=>e.eventType==='SITE_PENDING').length, cls: 'warn' },
    { label: 'Quotes ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', type: 'info', filter: 'QUOTE_SENT', val: allEvents.filter(e=>e.eventType==='QUOTE_SENT').length, cls: '' },
    { label: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', type: 'warn', filter: 'ADD_PRODUCT', val: allEvents.filter(e=>e.eventType==='ADD_PRODUCT').length, cls: 'warn' },
    { label: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≠‡∏á', type: 'alert', filter: 'BOOKING_REQUEST', val: allEvents.filter(e=>e.eventType==='BOOKING_REQUEST').length, cls: 'alert' },
    { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó‡πÅ‡∏•‡πâ‡∏ß', type: 'success', filter: 'BOOKING_CONFIRMED', val: allEvents.filter(e=>e.eventType==='BOOKING_CONFIRMED').length, cls: 'success' },
    { label: '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞', type: 'alert', filter: 'PAYMENT_PENDING', val: allEvents.filter(e=>e.eventType==='PAYMENT_PENDING').length, cls: 'alert' },
    { label: '‡πÄ‡∏ó <24h', type: 'warn', filter: 'POUR_REMINDER', val: allEvents.filter(e=>e.eventType==='POUR_REMINDER').length, cls: 'warn' },
    { label: 'Dispatch Live', type: 'alert', filter: 'DISPATCH_LIVE', val: allEvents.filter(e=>e.eventType==='DISPATCH_LIVE').length, cls: 'alert' },
  ];

  const strip = document.getElementById('kpiStrip');
  strip.innerHTML = kpis.map((k,i) => `
    <div class="kpi-card ${k.cls} ${selectedKpi===k.filter?'selected':''}" onclick="filterByKpi('${k.filter}',this)">
      <div class="kpi-value">${k.val}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

function filterByKpi(type, el) {
  if (selectedKpi === type) {
    selectedKpi = null;
    document.getElementById('fType').value = '';
  } else {
    selectedKpi = type;
    document.getElementById('fType').value = type;
  }
  document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('selected'));
  if (selectedKpi) el.classList.add('selected');
  applyFilters();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABLE RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function formatQty(value) {
  return Number(value || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function updateTableHeader() {
  const titleEl = document.getElementById('tableTitle');
  const countEl = document.getElementById('tableCount');
  const badgeEl = document.getElementById('newBadge');
  if (!titleEl || !countEl || !badgeEl) return;

  if (activeMainTab === 'daily-pour') {
    titleEl.textContent = '‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á Dealer';
    countEl.textContent = `${filteredDailyPourRows.length} ‡∏á‡∏≤‡∏ô`;
    badgeEl.style.display = 'none';
    return;
  }

  titleEl.textContent = 'Activity Time Log';
  countEl.textContent = `${filteredEvents.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  if (newEventIds.size > 0) {
    if (!badgeEl.textContent || badgeEl.textContent === '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà') {
      badgeEl.textContent = `${newEventIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà`;
    }
    badgeEl.style.display = 'inline-flex';
  } else {
    badgeEl.style.display = 'none';
  }
}

function renderActivityTable() {
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageEvents = filteredEvents.slice(start, start + PAGE_SIZE);
  const tbody = document.getElementById('actBody');
  if (!tbody) return;

  if (pageEvents.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="emoji">üì≠</div><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3><p>‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô filter ‡∏´‡∏£‡∏∑‡∏≠ refresh ‡πÉ‡∏´‡∏°‡πà</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = pageEvents.map(e => {
    const ts = new Date(e.ts);
    const isNew = newEventIds.has(e.id);
    const evtInfo = EVENT_TYPES[e.eventType] || { label: e.eventType, icon: '‚Ä¢' };
    const stateInfo = STATES[e.status.currentState] || { label: e.status.currentState, cls: 'state-new' };
    const isPending = e.status.currentState === 'PENDING_APPROVAL';
    const isDone = e.isDone;

    return `
    <tr class="${isNew?'is-new':''} ${selectedEventId===e.id?'selected-row':''}" onclick="openDrawer('${e.id}')">
      <td class="time-cell">
        ${fmtTime(ts)}
        ${isNew?`<span class="new-badge">‚óè NEW</span>`:''}
      </td>
      <td><span class="sev-chip sev-${e.severity.toLowerCase()}">${e.severity==='ALERT'?'üî¥':e.severity==='WARN'?'üü°':'üîµ'} ${e.severity}</span></td>
      <td class="event-type-cell">
        ${evtInfo.icon} ${evtInfo.label}
        <span>#${e.id}</span>
      </td>
      <td class="customer-cell">
        <div class="customer-name">${escHtml(e.customer.lineName)}</div>
        <div class="customer-phone">${e.customer.phone} <button class="copy-btn" onclick="event.stopPropagation();copyText('${e.customer.phone}')">Copy</button></div>
      </td>
      <td class="site-cell">
        <div class="site-code">${e.site.siteCode}</div>
        <div class="site-name">${escHtml(e.site.projectName)}</div>
        <div class="site-prov">üìç ${e.site.province}</div>
        <button class="map-btn" onclick="event.stopPropagation();openMap('${e.site.mapUrl}')">üó∫ Map</button>
      </td>
      <td class="key-detail">${escHtml(e.keyDetail)}</td>
      <td><span class="state-chip ${stateInfo.cls}">${isDone?'‚úì Done':stateInfo.label}</span></td>
      <td><div class="action-btns" onclick="event.stopPropagation()">
        <button class="act-btn view" title="‡∏î‡∏π Detail" onclick="openDrawer('${e.id}')">üëÅ</button>
        <button class="act-btn call" title="‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" onclick="window.open('tel:${e.customer.phone}')">üìû</button>
        <button class="act-btn line" title="‡πÄ‡∏õ‡∏¥‡∏î LINE" onclick="window.open('https://line.me/')">üí¨</button>
        ${isPending && !isDone ? `
          <button class="act-btn approve" title="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" onclick="quickApprove('${e.id}')">‚úÖ</button>
          <button class="act-btn reject" title="‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" onclick="quickReject('${e.id}')">‚ùå</button>
        ` : ''}
        ${!isDone ? `<button class="act-btn done" title="Mark Done" onclick="markDone('${e.id}')">‚òë</button>` : ''}
      </div></td>
    </tr>`;
  }).join('');
}

function renderPouredQtyCell(row) {
  const qtyText = formatQty(row.pouredQty);
  if (!row.trackingUrl) return qtyText;
  return `<a class="num-link" href="${escHtml(row.trackingUrl)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">${qtyText}</a>`;
}

function renderDailyPourTable() {
  const start = (currentPourPage - 1) * PAGE_SIZE;
  const pageRows = filteredDailyPourRows.slice(start, start + PAGE_SIZE);
  const tbody = document.getElementById('pourBody');
  if (!tbody) return;

  if (pageRows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="11"><div class="empty-state"><div class="emoji">üöß</div><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3><p>‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô filter ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = pageRows.map(r => `
    <tr class="${(r.sourceEventId && selectedEventId===r.sourceEventId)?'selected-row':''}" ${r.sourceEventId ? `onclick="openDrawer('${r.sourceEventId}')"` : 'style="cursor:default"'}>
      <td class="mono">${escHtml(r.bookingId)}</td>
      <td><span class="status-pill ${r.statusCls}">${escHtml(r.statusLabel)}</span></td>
      <td>${escHtml(r.agency)}</td>
      <td>${escHtml(r.contractor)}</td>
      <td class="mono">${escHtml(r.productCode)}</td>
      <td class="num-cell">${formatQty(r.bookedQty)}</td>
      <td class="num-cell">${formatQty(r.confirmedQty)}</td>
      <td class="num-cell">${renderPouredQtyCell(r)}</td>
      <td class="num-cell">${formatQty(r.pendingQty)}</td>
      <td><span class="pump-pill ${r.hasPump?'on':''}">${r.pump}</span></td>
      <td>${new Date(r.pourDate).toLocaleDateString('th-TH')}</td>
    </tr>
  `).join('');
}

function renderActivityPagination() {
  const totalPages = Math.ceil(filteredEvents.length / PAGE_SIZE);
  const pg = document.getElementById('pagination');
  const pgPour = document.getElementById('paginationPour');
  if (pgPour) pgPour.innerHTML = '';
  if (!pg) return;
  if (totalPages <= 1) { pg.innerHTML = ''; return; }

  let html = `<button class="page-btn" onclick="goPage(${currentPage-1})" ${currentPage<=1?'disabled':''}>‚Äπ</button>`;
  for (let p = Math.max(1, currentPage-2); p <= Math.min(totalPages, currentPage+2); p++) {
    html += `<button class="page-btn ${p===currentPage?'active':''}" onclick="goPage(${p})">${p}</button>`;
  }
  html += `<button class="page-btn" onclick="goPage(${currentPage+1})" ${currentPage>=totalPages?'disabled':''}>‚Ä∫</button>`;
  html += `<span class="page-info">‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}/${totalPages} | ${filteredEvents.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
  pg.innerHTML = html;
}

function renderDailyPourPagination() {
  const totalPages = Math.ceil(filteredDailyPourRows.length / PAGE_SIZE);
  const pg = document.getElementById('paginationPour');
  const pgAct = document.getElementById('pagination');
  if (pgAct) pgAct.innerHTML = '';
  if (!pg) return;
  if (totalPages <= 1) { pg.innerHTML = ''; return; }

  let html = `<button class="page-btn" onclick="goPagePour(${currentPourPage-1})" ${currentPourPage<=1?'disabled':''}>‚Äπ</button>`;
  for (let p = Math.max(1, currentPourPage-2); p <= Math.min(totalPages, currentPourPage+2); p++) {
    html += `<button class="page-btn ${p===currentPourPage?'active':''}" onclick="goPagePour(${p})">${p}</button>`;
  }
  html += `<button class="page-btn" onclick="goPagePour(${currentPourPage+1})" ${currentPourPage>=totalPages?'disabled':''}>‚Ä∫</button>`;
  html += `<span class="page-info">‡∏´‡∏ô‡πâ‡∏≤ ${currentPourPage}/${totalPages} | ${filteredDailyPourRows.length} ‡∏á‡∏≤‡∏ô</span>`;
  pg.innerHTML = html;
}

function renderTable() {
  updateTableHeader();
  if (activeMainTab === 'daily-pour') {
    renderDailyPourTable();
  } else {
    renderActivityTable();
  }
}

function renderPagination() {
  if (activeMainTab === 'daily-pour') {
    renderDailyPourPagination();
  } else {
    renderActivityPagination();
  }
}

function goPage(p) {
  const totalPages = Math.ceil(filteredEvents.length / PAGE_SIZE);
  if (p < 1 || p > totalPages) return;
  currentPage = p;
  renderTable();
  renderPagination();
}

function goPagePour(p) {
  const totalPages = Math.ceil(filteredDailyPourRows.length / PAGE_SIZE);
  if (p < 1 || p > totalPages) return;
  currentPourPage = p;
  renderTable();
  renderPagination();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAWER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openDrawer(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  selectedEventId = id;
  renderTable();

  const evtInfo = EVENT_TYPES[e.eventType] || { label: e.eventType, icon: '‚Ä¢' };
  const stateInfo = STATES[e.status.currentState] || { label: e.status.currentState, cls: 'state-new' };
  const isPending = e.status.currentState === 'PENDING_APPROVAL';

  document.getElementById('drawerTitle').textContent = `${evtInfo.icon} ${evtInfo.label}`;
  document.getElementById('drawerSubtitle').textContent = `${e.id} ¬∑ ${new Date(e.ts).toLocaleString('th-TH')}`;

  // Build history for same site
  const siteHistory = allEvents.filter(x => x.site.siteCode === e.site.siteCode && x.id !== e.id).slice(0,10);

  document.getElementById('drawerBody').innerHTML = `
    <!-- QUICK ACTIONS -->
    <div>
      <div class="drawer-section-title">Quick Actions</div>
      <div class="quick-actions">
        ${isPending && !e.isDone ? `
          <button class="qa-btn qa-approve" onclick="quickApprove('${e.id}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="qa-btn qa-reject" onclick="quickReject('${e.id}')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        `:''}
        ${e.eventType === 'INVOICE_CREATED' || e.eventType === 'QUOTE_SENT' ? `<button class="qa-btn qa-invoice" onclick="createInvoice('${e.id}')">üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice</button>` : ''}
        ${e.eventType === 'PAYMENT_PENDING' ? `<button class="qa-btn qa-approve" onclick="confirmPayment('${e.id}')">üí≥ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>` : ''}
        ${e.eventType === 'BOOKING_REQUEST' ? `<button class="qa-btn qa-slots" onclick="suggestSlots('${e.id}')">üìÖ ‡πÄ‡∏™‡∏ô‡∏≠ 3 Slots</button>` : ''}
        ${!e.isDone ? `<button class="qa-btn qa-done" onclick="markDone('${e.id}')">‚òë Mark Done</button>` : `<span style="font-size:12px;color:var(--success)">‚úì Done ‡πÇ‡∏î‡∏¢ ${e.doneBy} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${e.doneAt}</span>` }
      </div>
    </div>

    <!-- CUSTOMER & SITE -->
    <div>
      <div class="drawer-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ & ‡πÑ‡∏ã‡∏ï‡πå</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="info-val">${escHtml(e.customer.lineName)}</div></div>
        <div class="info-item"><div class="info-key">‡πÄ‡∏ö‡∏≠‡∏£‡πå</div><div class="info-val mono"><a href="tel:${e.customer.phone}" style="color:var(--primary)">${e.customer.phone}</a></div></div>
        <div class="info-item"><div class="info-key">Site Code</div><div class="info-val mono" style="color:var(--primary)">${e.site.siteCode}</div></div>
        <div class="info-item"><div class="info-key">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</div><div class="info-val">üìç ${e.site.province}</div></div>
        <div class="info-item info-item-wide" style="grid-column:1/-1"><div class="info-key">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div><div class="info-val">${escHtml(e.site.projectName)}</div></div>
      </div>
    </div>

    <!-- QUOTE INFO -->
    <div>
      <div class="drawer-section-title">Quotation</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">Quote No</div><div class="info-val mono">${e.quote.quoteNo}</div></div>
        <div class="info-item"><div class="info-key">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><div class="info-val">${escHtml(e.quote.itemsSummary)}</div></div>
        <div class="info-item"><div class="info-key">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="info-val price">${e.quote.customerPrice.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">Dealer Price</div><div class="info-val price">${e.quote.dealerPrice.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">Margin</div><div class="info-val margin">+${e.quote.margin.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div class="info-val"><span class="state-chip ${stateInfo.cls}">${stateInfo.label}</span></div></div>
      </div>
    </div>

    <!-- BOOKING -->
    <div>
      <div class="drawer-section-title">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á / ‡πÄ‡∏ó</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">Booking ID</div><div class="info-val mono">${e.booking.bookingId}</div></div>
        <div class="info-item"><div class="info-key">‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó</div><div class="info-val">${new Date(e.booking.pourDateTime).toLocaleString('th-TH',{dateStyle:'medium',timeStyle:'short'})}</div></div>
        <div class="info-item"><div class="info-key">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</div><div class="info-val">${e.booking.qtyM3} ‡∏•‡∏ö.‡∏°.</div></div>
        <div class="info-item"><div class="info-key">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</div><div class="info-val">${e.booking.truckType}</div></div>
        <div class="info-item info-item-wide" style="grid-column:1/-1"><div class="info-key">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</div><div class="info-val">üè≠ ${e.booking.plant}</div></div>
      </div>
    </div>

    <!-- INVOICE -->
    <div>
      <div class="drawer-section-title">Invoice / ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">Invoice No</div><div class="info-val mono">${e.invoice.invoiceNo}</div></div>
        <div class="info-item"><div class="info-key">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div><div class="info-val price">${e.invoice.total.toLocaleString('th-TH')}</div></div>
        <div class="info-item"><div class="info-key">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div class="info-val">${e.invoice.status}</div></div>
      </div>
    </div>

    <!-- TIMELINE -->
    <div>
      <div class="drawer-section-title">Timeline ‡∏Ç‡∏≠‡∏á Event ‡∏ô‡∏µ‡πâ</div>
      <div class="timeline">
        <div class="timeline-step">
          <div class="step-dot done">‚úì</div>
          <div class="step-content">
            <div class="step-title">Event ‡∏™‡∏£‡πâ‡∏≤‡∏á</div>
            <div class="step-time">${new Date(e.ts).toLocaleString('th-TH')}</div>
          </div>
        </div>
        <div class="timeline-step">
          <div class="step-dot ${e.status.currentState === 'PENDING_APPROVAL' ? 'active' : 'done'}">
            ${e.status.currentState === 'PENDING_APPROVAL' ? '‚è≥' : '‚úì'}
          </div>
          <div class="step-content">
            <div class="step-title">${e.status.currentState === 'PENDING_APPROVAL' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'}</div>
            <div class="step-time">${stateInfo.label}</div>
          </div>
        </div>
        <div class="timeline-step">
          <div class="step-dot pending">‚Üí</div>
          <div class="step-content">
            <div class="step-title">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
            <div class="step-note">‡∏£‡∏≠ Dealer ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SITE HISTORY -->
    <div>
      <div class="drawer-section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏ã‡∏ï‡πå ${e.site.siteCode} (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${siteHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
      ${siteHistory.length === 0 ? '<p style="font-size:12px;color:var(--text-muted)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>' : `
      <table class="history-table">
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody>${siteHistory.map(h => `
          <tr onclick="openDrawer('${h.id}')" style="cursor:pointer">
            <td style="font-family:var(--mono);font-size:10px">${fmtTime(new Date(h.ts))}</td>
            <td>${EVENT_TYPES[h.eventType]?.icon||''} ${EVENT_TYPES[h.eventType]?.label||h.eventType}</td>
            <td><span class="state-chip ${STATES[h.status.currentState]?.cls||'state-new'}" style="font-size:9px;padding:2px 6px">${STATES[h.status.currentState]?.label||h.status.currentState}</span></td>
          </tr>
        `).join('')}</tbody>
      </table>`}
    </div>
  `;

  document.getElementById('drawerOverlay').classList.add('open');
  document.getElementById('rightDrawer').classList.add('open');
  document.getElementById('mainContent').classList.add('drawer-open');
}

function closeDrawer() {
  selectedEventId = null;
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('rightDrawer').classList.remove('open');
  document.getElementById('mainContent').classList.remove('drawer-open');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ACTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function quickApprove(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  e.status.currentState = 'APPROVED';
  e.isDone = true;
  addAudit('APPROVE', id, `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${e.eventType}`);
  showToast(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
  renderTable(); renderKpis();
  if (selectedEventId === id) openDrawer(id);
}
function quickReject(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  e.status.currentState = 'REJECTED';
  addAudit('REJECT', id, `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${e.eventType}`);
  showToast(`‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${id}`, 'warn');
  renderTable(); renderKpis();
  if (selectedEventId === id) openDrawer(id);
}
function markDone(id) {
  const e = allEvents.find(x => x.id === id);
  if (!e) return;
  e.isDone = true;
  e.doneBy = currentUser?.name || 'dealer01';
  e.doneAt = new Date().toLocaleTimeString('th-TH');
  addAudit('MARK_DONE', id, `‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ${e.eventType}`);
  showToast(`‚òë Mark Done: ${id}`, 'success');
  renderTable();
  if (selectedEventId === id) openDrawer(id);
}
function createInvoice(id) {
  addAudit('CREATE_INVOICE', id, '‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice');
  showToast('üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
}
function confirmPayment(id) {
  const e = allEvents.find(x => x.id === id);
  if (e) { e.status.currentState = 'PAID'; e.isDone = true; }
  addAudit('CONFIRM_PAYMENT', id, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô');
  showToast('üí≥ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
  renderTable(); renderKpis();
  if (selectedEventId === id) openDrawer(id);
}
function suggestSlots(id) {
  addAudit('SUGGEST_SLOTS', id, '‡πÄ‡∏™‡∏ô‡∏≠ 3 time slots');
  showToast('üìÖ ‡∏™‡πà‡∏á 3 Slots ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUDIT LOG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addAudit(action, eventId, summary) {
  auditLog.unshift({ action, eventId, summary, user: currentUser?.name, ts: new Date().toLocaleString('th-TH') });
}
function openAuditLog() {
  const body = document.getElementById('auditBody');
  if (auditLog.length === 0) {
    body.innerHTML = '<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:20px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>';
  } else {
    body.innerHTML = auditLog.map(a => `
      <div class="audit-entry">
        <div><span class="audit-action">${a.action}</span> ‚Äî ${escHtml(a.summary)}</div>
        <div class="audit-meta">Event: ${a.eventId} ¬∑ ‡πÇ‡∏î‡∏¢: ${a.user} ¬∑ ${a.ts}</div>
      </div>
    `).join('');
  }
  document.getElementById('auditModal').classList.add('open');
}
function closeAuditLog() { document.getElementById('auditModal').classList.remove('open'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILITIES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openMap(url) { window.open(url, '_blank'); }
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'));
}
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function showToast(msg, type = '') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.classList.add('out'); setTimeout(() => t.remove(), 300); }, 2800);
}

loadDashboardSettings();

// Close audit on overlay click
document.getElementById('auditModal').addEventListener('click', function(e) {
  if (e.target === this) closeAuditLog();
});

// Clock update
setInterval(() => {
  if (currentUser) updateHeaderDate();
}, 1000);
</script>
</body>
</html>
